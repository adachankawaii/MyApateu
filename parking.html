<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlueMoon ‚Äî Th·∫ª xe & B√£i ƒë·∫≠u</title>
  <style>
    :root{
      --bg-grad-start:#3b82f6; --bg-grad-end:#1e3a8a;
      --text:#0b1226; --muted:#56607a; --card:#ffffff; --stroke:#e6eaf5;
      --toolbar-h:64px; --radius:18px;
      --shadow:0 18px 45px rgba(13,35,69,.18);
      --shadow-2:0 10px 28px rgba(13,35,69,.16);
    }
    [data-theme="dark"]{
      --bg-grad-start:#0f172a; --bg-grad-end:#0b1220;
      --text:#e5e7eb; --muted:#a3adc2; --card:#0b1226; --stroke:#1f2a44;
      --shadow:0 18px 45px rgba(0,0,0,.45); --shadow-2:0 10px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{
      color:var(--text);
      background: radial-gradient(1200px 800px at 70% 15%, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
      overflow-x:hidden;
    }

    /* Toolbar */
    .toolbar{
      position:fixed; inset:0 0 auto 0; height:var(--toolbar-h);
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
      padding:0 16px; z-index:20; color:#fff;
      background:linear-gradient(180deg,rgba(0,0,0,.18),rgba(0,0,0,.08));
      backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,.18);
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:999px; cursor:pointer;
      background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.18);
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }

    /* Main */
    .main{min-height:100%; padding-top:calc(var(--toolbar-h) + 28px); padding-bottom:40px;}
    .container{width:min(980px,92vw); margin:0 auto;}
    .title{margin:8px 0 18px; font-size:34px; font-weight:900; letter-spacing:.2px; color:#fff;}

    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow-2);
      padding:20px; margin-bottom:16px;
    }
    h2{margin:0 0 12px; font-size:20px; color:var(--text)}
    h3{margin:0 0 8px; font-size:16px; color:var(--text)}
    p{margin:6px 0; color:var(--muted)}
    .grid{display:grid; gap:16px}
    @media (min-width: 720px){ .grid{grid-template-columns: 1fr 1fr;} }

    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:12px; border:1px solid var(--stroke);
      background:var(--card); cursor:pointer; box-shadow:var(--shadow-2); text-decoration:none; color:inherit;
      font-weight:600; transition:transform .1s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:#2563eb; color:#fff; border-color:#2563eb}
    .btn.success{background:#16a34a; color:#fff; border-color:#16a34a}
    .btn.warning{background:#f59e0b; color:#fff; border-color:#f59e0b}
    .btn.danger{background:#ef4444; color:#fff; border-color:#ef4444}

    .tabs{
      display:flex; gap:4px; margin-bottom:20px; background:var(--stroke); border-radius:12px; padding:4px;
    }
    .tab{
      flex:1; padding:8px 16px; border-radius:8px; text-align:center; cursor:pointer;
      font-weight:600; transition:all .2s ease; border:none; background:transparent; color:var(--muted);
    }
    .tab.active{background:var(--card); color:var(--text); box-shadow:var(--shadow-2)}

    /* Forms */
    .form-group{margin-bottom:16px}
    .form-label{display:block; margin-bottom:6px; font-weight:600; color:var(--text)}
    .form-control{
      width:100%; padding:12px; border:1px solid var(--stroke); border-radius:8px;
      background:var(--card); color:var(--text); font-family:inherit;
    }
    .form-control:focus{outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 640px){.form-row{grid-template-columns:1fr}}

    /* Vehicle cards */
    .vehicle-card{
      border:1px solid var(--stroke); border-radius:12px; padding:16px; margin-bottom:12px;
      transition:box-shadow .2s ease; background:var(--card);
    }
    .vehicle-card:hover{box-shadow:var(--shadow-2)}
    .vehicle-header{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px}
    .vehicle-info h3{margin:0; color:var(--text)}
    .vehicle-info p{margin:0; color:var(--muted); font-size:14px}
    .vehicle-status{
      padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;
    }
    .status-active{background:#dcfce7; color:#166534}
    .status-pending{background:#fef3c7; color:#92400e}
    .status-expired{background:#fef2f2; color:#dc2626}
    [data-theme="dark"] .status-active{background:#052e16; color:#4ade80}
    [data-theme="dark"] .status-pending{background:#451a03; color:#fbbf24}
    [data-theme="dark"] .status-expired{background:#450a0a; color:#f87171}

    .vehicle-details{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:8px; margin:12px 0}
    .detail-item{display:flex; align-items:center; gap:8px; color:var(--text); font-size:14px}

    /* Parking spots */
    .parking-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(60px,1fr)); gap:8px; margin:16px 0;
    }
    .parking-spot{
      aspect-ratio:1; border:2px solid var(--stroke); border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:12px; cursor:pointer; transition:all .2s ease;
    }
    .spot-available{background:#dcfce7; color:#166534; border-color:#16a34a}
    .spot-occupied{background:#fef2f2; color:#dc2626; border-color:#ef4444}
    .spot-reserved{background:#fef3c7; color:#92400e; border-color:#f59e0b}
    .spot-selected{background:#dbeafe; color:#1e40af; border-color:#3b82f6; transform:scale(1.05)}

    [data-theme="dark"] .spot-available{background:#052e16; color:#4ade80; border-color:#16a34a}
    [data-theme="dark"] .spot-occupied{background:#450a0a; color:#f87171; border-color:#ef4444}
    [data-theme="dark"] .spot-reserved{background:#451a03; color:#fbbf24; border-color:#f59e0b}
    [data-theme="dark"] .spot-selected{background:#1e3a8a; color:#bfdbfe; border-color:#3b82f6}

    .legend{display:flex; gap:16px; flex-wrap:wrap; margin:12px 0; font-size:14px}
    .legend-item{display:flex; align-items:center; gap:6px}
    .legend-dot{width:12px; height:12px; border-radius:50%}

    /* Statistics */
    .stats{display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; margin:16px 0}
    .stat-item{text-align:center; padding:12px; background:var(--card); border:1px solid var(--stroke); border-radius:8px}
    .stat-number{font-size:24px; font-weight:900; color:var(--text)}
    .stat-label{font-size:12px; color:var(--muted); margin-top:4px}

    /* QR Code display */
    .qr-display{
      display:flex; flex-direction:column; align-items:center; padding:20px; background:var(--card);
      border:1px solid var(--stroke); border-radius:12px; text-align:center;
    }
    .qr-code{
      width:150px; height:150px; background:#f9fafb; border:1px solid var(--stroke); border-radius:8px;
      display:flex; align-items:center; justify-content:center; margin-bottom:12px; font-size:12px; color:var(--muted);
    }
    [data-theme="dark"] .qr-code{background:#1f2937}

    @media (max-width: 768px) {
      .tabs{flex-direction:column}
      .parking-grid{grid-template-columns:repeat(8,1fr)}
      .vehicle-header{flex-direction:column; align-items:flex-start; gap:8px}
    }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <header class="toolbar" role="banner">
    <button class="icon-btn" id="btnBack">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
    <div></div>
    <button class="icon-btn" id="btnNotifications">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 22a2.5 2.5 0 0 0 2.4-2H9.6A2.5 2.5 0 0 0 12 22Z" fill="white" opacity=".9"/>
        <path d="M19 17H5l1.2-1.8A2 2 0 0 0 7 14v-3a5 5 0 1 1 10 0v3c0 .4.1.8.3 1.2L19 17Z" stroke="white" stroke-width="1.8" fill="none" opacity=".9"/>
      </svg>
    </button>
  </header>

  <!-- Content -->
  <main class="main">
    <div class="container">
      <h1 class="title">Th·∫ª xe & B√£i ƒë·∫≠u</h1>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('vehicles')">üöó Ph∆∞∆°ng ti·ªán</button>
        <button class="tab" onclick="showTab('parking')">üÖøÔ∏è B√£i ƒë·∫≠u</button>
        <button class="tab" onclick="showTab('register')">üìù ƒêƒÉng k√Ω</button>
        <button class="tab" onclick="showTab('history')">üìã L·ªãch s·ª≠</button>
      </div>

      <!-- Vehicles Tab -->
      <div id="tab-vehicles" class="tab-content">
        <section class="card">
          <h2>üöó Ph∆∞∆°ng ti·ªán ƒë√£ ƒëƒÉng k√Ω</h2>
          <div id="vehiclesList">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              <div>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
          </div>
        </section>

        <!-- Quick Actions -->
        <section class="card">
          <h2>‚ö° Thao t√°c nhanh</h2>
          <div style="display:flex; gap:12px; flex-wrap:wrap">
            <button class="btn primary" onclick="showTab('register')">‚ûï ƒêƒÉng k√Ω xe m·ªõi</button>
            <button class="btn success" onclick="payParkingFee()">üí≥ Thanh to√°n ph√≠ ƒë·∫≠u xe</button>
            <button class="btn" onclick="downloadReport()">üìä T·∫£i b√°o c√°o</button>
          </div>
        </section>
      </div>

      <!-- Parking Tab -->
      <div id="tab-parking" class="tab-content" style="display:none">
        <section class="card">
          <h2>üÖøÔ∏è S∆° ƒë·ªì b√£i ƒë·∫≠u xe</h2>
          
          <!-- Legend -->
          <div class="legend" id="parkingLegend">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              <div>‚è≥ ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
          </div>

          <!-- Parking Grid will be dynamically loaded -->
          <div id="parkingZones">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              <div>‚è≥ ƒêang t·∫£i s∆° ƒë·ªì b√£i ƒë·∫≠u...</div>
            </div>
          </div>
        </section>

        <!-- Parking Statistics -->
        <section class="card">
          <h2>üìä Th·ªëng k√™ b√£i ƒë·∫≠u</h2>
          <div class="stats" id="parkingStats">
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">T·ªïng ch·ªó ƒë·∫≠u</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">ƒêang s·ª≠ d·ª•ng</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">C√≤n tr·ªëng</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">ƒê√£ ƒë·∫∑t ch·ªó</div>
            </div>
          </div>
        </section>
      </div>

      <!-- Register Tab -->
      <div id="tab-register" class="tab-content" style="display:none">
        <section class="card">
          <h2>üìù ƒêƒÉng k√Ω ph∆∞∆°ng ti·ªán m·ªõi</h2>
          
          <form id="vehicleForm">
            <div class="form-group">
              <label class="form-label">üöó Lo·∫°i ph∆∞∆°ng ti·ªán</label>
              <select class="form-control" id="vehicleType" required>
                <option value="">-- Ch·ªçn lo·∫°i xe --</option>
                <option value="car">üöó √î t√¥</option>
                <option value="motorcycle">üèçÔ∏è Xe m√°y</option>
                <option value="bicycle">üö≤ Xe ƒë·∫°p</option>
                <option value="electric">‚ö° Xe ƒëi·ªán</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">üè∑Ô∏è Bi·ªÉn s·ªë xe</label>
                <input type="text" class="form-control" id="licensePlate" placeholder="VD: 30A-12345" required>
              </div>
              <div class="form-group">
                <label class="form-label">üè≠ H√£ng xe</label>
                <input type="text" class="form-control" id="vehicleBrand" placeholder="VD: Honda, Toyota..." required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">üöô Model</label>
                <input type="text" class="form-control" id="vehicleModel" placeholder="VD: City, Vios..." required>
              </div>
              <div class="form-group">
                <label class="form-label">üé® M√†u s·∫Øc</label>
                <input type="text" class="form-control" id="vehicleColor" placeholder="VD: Tr·∫Øng, ƒêen..." required>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">üë§ Ch·ªß s·ªü h·ªØu</label>
              <input type="text" class="form-control" id="ownerName" placeholder="H·ªç v√† t√™n ch·ªß xe" required>
            </div>

            <div class="form-group">
              <label class="form-label">üì± S·ªë ƒëi·ªán tho·∫°i</label>
              <input type="tel" class="form-control" id="ownerPhone" placeholder="0901234567" required>
            </div>

            <div class="form-group">
              <label class="form-label">üìÑ Ghi ch√∫</label>
              <textarea class="form-control" id="notes" placeholder="Th√¥ng tin b·ªï sung (tu·ª≥ ch·ªçn)"></textarea>
            </div>

            <div style="display:flex; gap:12px; margin-top:20px">
              <button type="submit" class="btn primary">üìù ƒêƒÉng k√Ω</button>
              <button type="reset" class="btn">üîÑ L√†m m·ªõi</button>
            </div>
          </form>
        </section>

        <!-- QR Code Display -->
        <section class="card" id="qrSection" style="display:none">
          <h2>üì± M√£ QR th·∫ª xe</h2>
          <div class="qr-display">
            <div class="qr-code" id="qrCode">
              M√£ QR s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y
            </div>
            <h3 id="qrTitle">Th·∫ª xe #CAR001</h3>
            <p id="qrDetails">Honda City - 30A-12345</p>
            <div style="display:flex; gap:8px">
              <button class="btn primary" onclick="downloadQR()">üíæ T·∫£i xu·ªëng</button>
              <button class="btn" onclick="shareQR()">üì§ Chia s·∫ª</button>
              <button class="btn" onclick="closeQR()">‚úï ƒê√≥ng</button>
            </div>
          </div>
        </section>
      </div>

      <!-- History Tab -->
      <div id="tab-history" class="tab-content" style="display:none">
        <section class="card">
          <h2>üìã L·ªãch s·ª≠ giao d·ªãch</h2>
          <div id="transactionsList">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              <div>‚è≥ ƒêang t·∫£i l·ªãch s·ª≠...</div>
            </div>
          </div>
        </section>
      </div>

      <div style="margin-top:20px; text-align:center">
        <a href="home_resident.html" class="btn">‚Üê V·ªÅ trang ch·ªß</a>
      </div>
    </div>
  </main>

  <script>
    // API Configuration
    const API_BASE = 'http://localhost:3001/api';
    
    // Global state
    let vehiclesData = [];
    let parkingData = [];
    let transactionsData = [];
    
    // ƒê·ªìng b·ªô theme
    const theme = localStorage.getItem('bm_theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    
    // Navigation
    document.getElementById('btnBack').addEventListener('click', () => {
      window.location.href = 'home_resident.html';
    });

    document.getElementById('btnNotifications').addEventListener('click', () => {
      alert('Th√¥ng b√°o: Ph√≠ ƒë·∫≠u xe th√°ng 11 s·∫Ω ƒë·∫øn h·∫°n v√†o ng√†y 1/11');
    });

    // API Functions
    async function fetchVehicles() {
      try {
        const response = await fetch(`${API_BASE}/vehicles`);
        const data = await response.json();
        vehiclesData = data.vehicles;
        renderVehicles();
      } catch (error) {
        console.error('Error fetching vehicles:', error);
        document.getElementById('vehiclesList').innerHTML = `
          <div style="text-align:center; padding:20px; color:#ef4444">
            <div>‚ùå L·ªói k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu</div>
            <div style="font-size:14px; margin-top:8px">Vui l√≤ng kh·ªüi ƒë·ªông server: npm run dev</div>
          </div>
        `;
      }
    }

    async function fetchParkingSpots() {
      try {
        const [spotsResponse, statsResponse] = await Promise.all([
          fetch(`${API_BASE}/parking/spots`),
          fetch(`${API_BASE}/parking/stats`)
        ]);
        
        const spotsData = await spotsResponse.json();
        const statsData = await statsResponse.json();
        
        parkingData = spotsData.parking_zones;
        renderParkingSpots();
        renderParkingStats(statsData.stats);
      } catch (error) {
        console.error('Error fetching parking data:', error);
        document.getElementById('parkingZones').innerHTML = `
          <div style="text-align:center; padding:20px; color:#ef4444">
            <div>‚ùå L·ªói t·∫£i d·ªØ li·ªáu b√£i ƒë·∫≠u</div>
          </div>
        `;
      }
    }

    async function fetchTransactions() {
      try {
        const response = await fetch(`${API_BASE}/transactions`);
        const data = await response.json();
        transactionsData = data.transactions;
        renderTransactions();
      } catch (error) {
        console.error('Error fetching transactions:', error);
        document.getElementById('transactionsList').innerHTML = `
          <div style="text-align:center; padding:20px; color:#ef4444">
            <div>‚ùå L·ªói t·∫£i l·ªãch s·ª≠ giao d·ªãch</div>
          </div>
        `;
      }
    }

    // Render Functions
    function renderVehicles() {
      const container = document.getElementById('vehiclesList');
      
      if (vehiclesData.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--muted)">
            <div>üìù Ch∆∞a c√≥ ph∆∞∆°ng ti·ªán n√†o ƒë∆∞·ª£c ƒëƒÉng k√Ω</div>
            <button class="btn primary" onclick="showTab('register')" style="margin-top:12px">‚ûï ƒêƒÉng k√Ω xe ƒë·∫ßu ti√™n</button>
          </div>
        `;
        return;
      }

      container.innerHTML = vehiclesData.map(vehicle => {
        const statusClass = {
          'active': 'status-active',
          'pending': 'status-pending',
          'expired': 'status-expired'
        }[vehicle.status] || 'status-pending';

        const statusText = {
          'active': 'ƒêang ho·∫°t ƒë·ªông',
          'pending': 'Ch·ªù duy·ªát',
          'expired': 'H·∫øt h·∫°n'
        }[vehicle.status] || 'Kh√¥ng x√°c ƒë·ªãnh';

        const vehicleIcon = {
          'car': 'üöó',
          'motorcycle': 'üèçÔ∏è',
          'bicycle': 'üö≤',
          'electric': '‚ö°'
        }[vehicle.type] || 'üöó';

        return `
          <div class="vehicle-card">
            <div class="vehicle-header">
              <div class="vehicle-info">
                <h3>${vehicleIcon} ${vehicle.brand} ${vehicle.model}</h3>
                <p>Bi·ªÉn s·ªë: ${vehicle.license_plate}</p>
              </div>
              <span class="vehicle-status ${statusClass}">${statusText}</span>
            </div>
            <div class="vehicle-details">
              <div class="detail-item">
                <span>üé´</span>
                <span>Th·∫ª: ${vehicle.card_id || 'ƒêang x·ª≠ l√Ω'}</span>
              </div>
              <div class="detail-item">
                <span>üÖøÔ∏è</span>
                <span>V·ªã tr√≠: ${vehicle.parking_spot || 'Ch∆∞a ph√¢n b·ªï'}</span>
              </div>
              <div class="detail-item">
                <span>üìÖ</span>
                <span>${vehicle.expiry_date ? `H·∫øt h·∫°n: ${formatDate(vehicle.expiry_date)}` : `ƒêƒÉng k√Ω: ${formatDate(vehicle.created_date)}`}</span>
              </div>
              <div class="detail-item">
                <span>üí∞</span>
                <span>Ph√≠: ${formatCurrency(vehicle.monthly_fee)}/th√°ng</span>
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px">
              ${vehicle.status === 'active' ? `
                <button class="btn primary" onclick="showQR('${vehicle.card_id}')">üì± Xem m√£ QR</button>
                <button class="btn" onclick="extendCard('${vehicle.card_id}')">üìÖ Gia h·∫°n</button>
                <button class="btn warning" onclick="reportLost('${vehicle.card_id}')">‚ö†Ô∏è B√°o m·∫•t</button>
              ` : vehicle.status === 'pending' ? `
                <button class="btn" disabled>‚è≥ ƒêang x·ª≠ l√Ω</button>
                <button class="btn" onclick="editRegistration('${vehicle.id}')">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
              ` : `
                <button class="btn warning" onclick="renewVehicle('${vehicle.id}')">üîÑ Gia h·∫°n</button>
              `}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderParkingSpots() {
      const container = document.getElementById('parkingZones');
      const legendContainer = document.getElementById('parkingLegend');
      
      // Calculate stats for legend
      let totalAvailable = 0, totalOccupied = 0, totalReserved = 0;
      
      parkingData.forEach(zone => {
        zone.spots.forEach(spot => {
          switch(spot.status) {
            case 'available': totalAvailable++; break;
            case 'occupied': totalOccupied++; break;
            case 'reserved': totalReserved++; break;
          }
        });
      });

      // Render legend
      legendContainer.innerHTML = `
        <div class="legend-item">
          <div class="legend-dot spot-available"></div>
          <span>Tr·ªëng (${totalAvailable} ch·ªó)</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot spot-occupied"></div>
          <span>ƒê√£ ƒë·∫≠u (${totalOccupied} ch·ªó)</span>
        </div>
        <div class="legend-item">
          <div class="legend-dot spot-reserved"></div>
          <span>ƒê√£ ƒë·∫∑t (${totalReserved} ch·ªó)</span>
        </div>
      `;

      // Render parking zones
      container.innerHTML = parkingData.map(zone => {
        const zoneTitle = {
          'A': `üè¢ T·∫ßng ${zone.level} - Khu ${zone.zone} (√î t√¥)`,
          'B': `üèçÔ∏è T·∫ßng ${zone.level} - Khu ${zone.zone} (Xe m√°y)`
        }[zone.zone] || `Khu ${zone.zone}`;

        const spotsHtml = zone.spots.map(spot => {
          const statusClass = `spot-${spot.status}`;
          const tooltip = spot.status === 'occupied' && spot.license_plate 
            ? `${spot.brand} ${spot.model} (${spot.license_plate})`
            : '';

          return `
            <div class="parking-spot ${statusClass}" 
                 title="${tooltip}"
                 onclick="${spot.status === 'available' ? `selectSpot(this, '${spot.spot_id}')` : ''}"
                 style="${spot.status !== 'available' ? 'cursor: default;' : ''}">
              ${spot.spot_id}
            </div>
          `;
        }).join('');

        return `
          <h3>${zoneTitle}</h3>
          <div class="parking-grid">${spotsHtml}</div>
        `;
      }).join('');
    }

    function renderParkingStats(stats) {
      const container = document.getElementById('parkingStats');
      container.innerHTML = `
        <div class="stat-item">
          <div class="stat-number">${stats.total || 0}</div>
          <div class="stat-label">T·ªïng ch·ªó ƒë·∫≠u</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.occupied || 0}</div>
          <div class="stat-label">ƒêang s·ª≠ d·ª•ng</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.available || 0}</div>
          <div class="stat-label">C√≤n tr·ªëng</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.reserved || 0}</div>
          <div class="stat-label">ƒê√£ ƒë·∫∑t ch·ªó</div>
        </div>
      `;
    }

    function renderTransactions() {
      const container = document.getElementById('transactionsList');
      
      if (transactionsData.length === 0) {
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--muted)">
            <div>üìã Ch∆∞a c√≥ giao d·ªãch n√†o</div>
          </div>
        `;
        return;
      }

      container.innerHTML = transactionsData.map(transaction => {
        const statusClass = {
          'completed': 'status-active',
          'pending': 'status-pending',
          'failed': 'status-expired'
        }[transaction.status] || 'status-pending';

        const statusText = {
          'completed': transaction.type === 'registration_fee' ? 'Ho√†n th√†nh' : 'ƒê√£ thanh to√°n',
          'pending': 'ƒêang x·ª≠ l√Ω',
          'failed': 'Th·∫•t b·∫°i'
        }[transaction.status] || 'Kh√¥ng x√°c ƒë·ªãnh';

        const typeIcon = {
          'monthly_fee': 'üí≥',
          'registration_fee': 'üìù',
          'annual_fee': 'üîÑ'
        }[transaction.type] || 'üí∞';

        return `
          <div class="vehicle-card">
            <div class="vehicle-header">
              <div class="vehicle-info">
                <h3>${typeIcon} ${transaction.description}</h3>
                <p>${transaction.card_id ? `Th·∫ª xe ${transaction.card_id} - ` : ''}${transaction.brand} ${transaction.model}</p>
              </div>
              <span class="vehicle-status ${statusClass}">${statusText}</span>
            </div>
            <div class="vehicle-details">
              <div class="detail-item">
                <span>üìÖ</span>
                <span>${formatDate(transaction.transaction_date)}</span>
              </div>
              <div class="detail-item">
                <span>üí∞</span>
                <span>${formatCurrency(transaction.amount)}</span>
              </div>
              ${transaction.payment_method ? `
                <div class="detail-item">
                  <span>üè¶</span>
                  <span>${getPaymentMethodText(transaction.payment_method)}</span>
                </div>
              ` : ''}
              ${transaction.invoice_number ? `
                <div class="detail-item">
                  <span>üìÑ</span>
                  <span>#${transaction.invoice_number}</span>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Utility Functions
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN');
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN').format(amount) + 'ƒë';
    }

    function getPaymentMethodText(method) {
      const methods = {
        'bank_transfer': 'Chuy·ªÉn kho·∫£n',
        'cash': 'Ti·ªÅn m·∫∑t',
        'credit_card': 'Th·∫ª t√≠n d·ª•ng',
        'e_wallet': 'V√≠ ƒëi·ªán t·ª≠'
      };
      return methods[method] || method;
    }

    // Tab switching
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(`tab-${tabName}`).style.display = 'block';
      event.target.classList.add('active');

      // Load data when tab is shown
      if (tabName === 'vehicles' && vehiclesData.length === 0) {
        fetchVehicles();
      } else if (tabName === 'parking' && parkingData.length === 0) {
        fetchParkingSpots();
      } else if (tabName === 'history' && transactionsData.length === 0) {
        fetchTransactions();
      }
    }

    // Parking spot selection
    async function selectSpot(spotElement, spotId) {
      // Remove previous selection
      document.querySelectorAll('.parking-spot').forEach(spot => {
        spot.classList.remove('spot-selected');
      });
      
      // Add selection to clicked spot
      spotElement.classList.add('spot-selected');
      
      const confirmReservation = confirm(`üÖøÔ∏è ƒê·∫∑t ch·ªó ${spotId}?\n\nB·∫°n c√≥ mu·ªën ƒë·∫∑t v·ªã tr√≠ n√†y kh√¥ng?`);
      
      if (confirmReservation) {
        try {
          const response = await fetch(`${API_BASE}/parking/reserve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              spot_id: spotId, 
              vehicle_id: vehiclesData.find(v => v.status === 'active')?.id || 1 
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert(`‚úÖ ${result.message}`);
            fetchParkingSpots(); // Refresh parking data
          } else {
            alert(`‚ùå ${result.error}`);
          }
        } catch (error) {
          alert('‚ùå L·ªói k·∫øt n·ªëi server');
        }
      }
      
      // Remove selection
      spotElement.classList.remove('spot-selected');
    }

    // QR Code functions
    function showQR(cardId) {
      document.getElementById('qrSection').style.display = 'block';
      document.getElementById('qrCode').textContent = `QR Code: ${cardId}`;
      document.getElementById('qrTitle').textContent = `Th·∫ª xe ${cardId}`;
      
      // Scroll to QR section
      document.getElementById('qrSection').scrollIntoView({ behavior: 'smooth' });
    }

    function closeQR() {
      document.getElementById('qrSection').style.display = 'none';
    }

    function downloadQR() {
      alert('üíæ T·∫£i xu·ªëng m√£ QR th√†nh c√¥ng!\nFile ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o th∆∞ m·ª•c Downloads.');
    }

    function shareQR() {
      alert('üì§ Chia s·∫ª m√£ QR qua:\n‚Ä¢ Zalo\n‚Ä¢ Email\n‚Ä¢ Tin nh·∫Øn');
    }

    // Vehicle management functions
    function extendCard(cardId) {
      alert(`üìÖ Gia h·∫°n th·∫ª ${cardId}\nPh√≠ gia h·∫°n 12 th√°ng: 6.000.000ƒë\nChuy·ªÉn ƒë·∫øn trang thanh to√°n?`);
    }

    function reportLost(cardId) {
      if (confirm(`‚ö†Ô∏è B√°o m·∫•t th·∫ª ${cardId}?\n\nTh·∫ª c≈© s·∫Ω b·ªã v√¥ hi·ªáu h√≥a v√† b·∫°n c·∫ßn l√†m th·∫ª m·ªõi (ph√≠ 100.000ƒë).`)) {
        alert('‚úÖ ƒê√£ b√°o m·∫•t th·∫ª th√†nh c√¥ng!\nVui l√≤ng li√™n h·ªá ban qu·∫£n l√Ω ƒë·ªÉ l√†m th·∫ª m·ªõi.');
      }
    }

    function editRegistration(vehicleId) {
      alert(`‚úèÔ∏è Ch·ªânh s·ª≠a ƒëƒÉng k√Ω ${vehicleId}\nChuy·ªÉn ƒë·∫øn form ch·ªânh s·ª≠a...`);
    }

    function payParkingFee() {
      alert('üí≥ Thanh to√°n ph√≠ ƒë·∫≠u xe\n\nC√°c kho·∫£n c·∫ßn thanh to√°n:\n‚Ä¢ Th·∫ª #CAR001: 500.000ƒë (th√°ng 11)\n‚Ä¢ Th·∫ª #BIKE001: 100.000ƒë (ph√≠ ƒëƒÉng k√Ω)\n\nT·ªïng: 600.000ƒë');
    }

    function downloadReport() {
      alert('üìä T·∫£i b√°o c√°o th√†nh c√¥ng!\nFile Excel ch·ª©a:\n‚Ä¢ Danh s√°ch ph∆∞∆°ng ti·ªán\n‚Ä¢ L·ªãch s·ª≠ giao d·ªãch\n‚Ä¢ Th·ªëng k√™ s·ª≠ d·ª•ng');
    }

    // Vehicle registration form
    document.getElementById('vehicleForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = {
        type: document.getElementById('vehicleType').value,
        license_plate: document.getElementById('licensePlate').value,
        brand: document.getElementById('vehicleBrand').value,
        model: document.getElementById('vehicleModel').value,
        color: document.getElementById('vehicleColor').value,
        owner_name: document.getElementById('ownerName').value,
        owner_phone: document.getElementById('ownerPhone').value,
        notes: document.getElementById('notes').value
      };
      
      if (!formData.type || !formData.license_plate || !formData.brand || !formData.owner_name || !formData.owner_phone) {
        alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/vehicles`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`‚úÖ ${result.message}\nM√£ th·∫ª: ${result.card_id}\nTh·ªùi gian x·ª≠ l√Ω: 2-3 ng√†y l√†m vi·ªác`);
          
          // Reset form and refresh data
          document.getElementById('vehicleForm').reset();
          vehiclesData = []; // Clear cache to force refresh
          showTab('vehicles');
        } else {
          alert(`‚ùå ${result.error}`);
        }
      } catch (error) {
        alert('‚ùå L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Load vehicles data on first tab (default)
      fetchVehicles();
    });

    // Update parking statistics (kept for backward compatibility)
    function updateParkingStats() {
      // This function is now handled by renderParkingStats
      return;
    }

    // Initialize
    // updateParkingStats(); // Removed static call
  </script>
</body>
</html>