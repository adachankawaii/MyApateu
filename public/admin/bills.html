<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Phí & Thanh toán - BlueMoon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 70% 15%, #3b82f6 0%, #1e3a8a 100%);
      margin: 0;
      position:relative;
      overflow-x:hidden;
    }

    /* ===== Nền toà nhà ===== */
    .scene{
      position:absolute; inset:0; pointer-events:none; z-index:0;
      opacity:.48; filter: blur(2px) saturate(95%);
    }
    .sky-sheen{
      position:absolute; inset:-10% -10% auto -10%; height:60%;
      background: radial-gradient(45% 40% at 75% 25%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%);
    }
    .city{
      position:absolute; left:50%; bottom:-2%; transform:translateX(-50%);
      width:1400px; max-width:180vw; height:60vh;
    }
    .tower{
      position:absolute; bottom:0;
      width: var(--w,140px); height: var(--h,46vh);
      border-radius:18px; 
      background:
        linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0) 30%) padding-box,
        linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,0) 55%) border-box,
        linear-gradient(180deg, rgba(46,106,240,.85), rgba(30,64,175,.9));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.15);
    }
    .tower::after{
      content:""; position:absolute; inset:10% 12% 8% 12%;
      background:
        repeating-linear-gradient(#0000 0 16px, #0000 0 44px, rgba(255,255,255,.5) 0 60px),
        repeating-linear-gradient(90deg, #0000 0 22px, #0000 0 56px, rgba(255,255,255,.48) 0 70px);
      mix-blend-mode:screen; opacity:.16; border-radius:12px;
    }
    .t1{ --w:150px; --h:48vh; left:2%;  background-image: linear-gradient(180deg, rgba(80,139,255,.85), rgba(34,86,231,.92)); }
    .t2{ --w:110px; --h:42vh; left:10%; transform:skewX(-2deg); }
    .t3{ --w:180px; --h:54vh; left:18%; }
    .t4{ --w:130px; --h:38vh; left:29%; }
    .t5{ --w:240px; --h:58vh; left:38%; border-radius:22px; }
    .t6{ --w:120px; --h:36vh; left:53%; }
    .t7{ --w:170px; --h:50vh; left:62%; }
    .t8{ --w:140px; --h:40vh; left:73%; }
    .t9{ --w:210px; --h:56vh; left:82%; }
    .roof{
      position:absolute; width:60%; height:8px; left:20%; top:-8px; border-radius:999px;
      background: rgba(131, 131, 131, 0.38);
      box-shadow:0 6px 24px rgba(0,0,0,.25);
    }

    .container { max-width: 1200px; margin: 24px auto; padding: 16px; position:relative; z-index:1; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,.08); overflow: hidden; }
    .header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .header h2 { margin: 0 16px 0 0; font-size: 20px; }
    input, select, button { padding: 8px 10px; border-radius: 10px; border: 1px solid #ddd; outline: none; font-size: 14px; }
    input:focus, select:focus { border-color: #4a90e2; }
    .btn { background: #0e3c8a; color: #fff; border: none; cursor: pointer; }
    .btn.secondary { background: #f3f4f6; color: #111827; border: 1px solid #e5e7eb; }
    .btn.sm { padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: default; }
    .table-wrap { overflow: auto; max-height: calc(100vh - 240px); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; white-space: nowrap; }
    th { background: #fafafa; font-weight: 600; position: sticky; top: 0; z-index: 1; }
    .actions button { margin-right: 4px; }
    .badge-late { color: #b42318; background: #fee2e2; padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .badge-status { padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge-status.UNPAID { background: #fee2e2; color: #b91c1c; }
    .badge-status.PARTIAL { background: #fef3c7; color: #92400e; }
    .badge-status.PAID { background: #dcfce7; color: #166534; }
    .badge-status.CANCELLED { background: #e5e7eb; color: #374151; }
    .toolbar { margin-left: auto; display: flex; gap: 8px; }
    .pagination { display: flex; gap: 8px; align-items: center; padding: 12px 20px; border-top: 1px solid #eee; }
    .muted { color: #6b7280; font-size: 13px; }
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:999px;background:rgba(255,255,255);border:1px solid rgba(255,255,255,.18);cursor:pointer;margin:12px 12px 0;}
    .icon-btn:hover{background:rgba(255,255,255,.85);}
    /* modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.25); z-index: 50; }
    .modal.show { display: flex; }
    .modal .dialog { width: 720px; max-width: 96vw; background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,.2); }
    .dialog .head { padding: 16px 20px; border-bottom: 1px solid #eee; font-weight: 600; display:flex;justify-content:space-between;align-items:center;}
    .dialog .body { padding: 16px 20px; display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
    .dialog .foot { padding: 12px 20px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid #eee; }
    .full { grid-column: 1/-1; }
    label { font-size: 13px; color: #374151; }
    .hint { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .pill { font-size: 12px; padding: 2px 6px; border-radius: 999px; background:#f3f4f6; }
    .text-right { text-align: right; }
    .text-xs { font-size: 11px; }
    .bordered-table { border-collapse: collapse; width: 100%; font-size: 12px; }
    .bordered-table th, .bordered-table td { border: 1px solid #e5e7eb; padding: 6px 8px; }
    .bill-row { cursor: pointer; transition: background 0.2s; }
    .bill-row:hover { background: #f9fafb; }
    .bill-row.active { background: #eff6ff; }
    .action-row { background: #f9fafb; }
    .action-row td { padding: 12px 20px; border-top: none; }
    .action-btns { display: flex; gap: 8px; }
  </style>
</head>
<body>
  <!-- ===== Nền toà nhà ===== -->
  <div class="scene" aria-hidden="true">
    <div class="sky-sheen"></div>
    <div class="city">
      <div class="tower t1"><span class="roof"></span></div>
      <div class="tower t2"><span class="roof"></span></div>
      <div class="tower t3"><span class="roof"></span></div>
      <div class="tower t4"><span class="roof"></span></div>
      <div class="tower t5"><span class="roof"></span></div>
      <div class="tower t6"><span class="roof"></span></div>
      <div class="tower t7"><span class="roof"></span></div>
      <div class="tower t8"><span class="roof"></span></div>
      <div class="tower t9"><span class="roof"></span></div>
    </div>
  </div>

  <a id="Back" class="icon-btn" title="Về trang quản trị">⟵</a>
  <div class="container">
    <div class="card">
      <div class="header">
        <h2>Phí & Thanh toán</h2>

        <input id="q" placeholder="Tìm phòng / biển số / tên phí..." />
        <select id="fee_type">
          <option value="">Loại phí</option>
          <option value="ROOM">Phí phòng</option>
          <option value="PARKING">Phí bãi xe</option>
          <option value="OTHER">Khác</option>
        </select>
        <select id="status">
          <option value="">Trạng thái</option>
          <option value="UNPAID">Chưa thanh toán</option>
          <option value="PARTIAL">Đang nợ</option>
          <option value="PAID">Đã thanh toán</option>
          <option value="CANCELLED">Hủy</option>
        </select>
        <input id="period" type="month" />

        <select id="room_filter">
          <option value="">Tất cả phòng</option>
        </select>

        <div class="toolbar">
          <button id="btnSearch" class="btn">Lọc</button>
          <button id="btnAdd" class="btn">+ Thêm khoản thu</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>Phòng</th>
              <th>Biển số</th>
              <th>Tên phí</th>
              <th>Loại</th>
              <th>Kỳ</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Cần thu</th>
              <th>Đã nộp</th>
              <th>Còn thiếu</th>
              <th>Hạn nộp</th>
              <th>Trạng thái</th>
              <th>Tạo lúc</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pagination">
        <div id="total" class="muted">0 bản ghi</div>
        <div style="margin-left:auto;"></div>
        <button id="prev" class="btn secondary">← Trước</button>
        <span id="pageinfo" class="muted">1/1</span>
        <button id="next" class="btn secondary">Sau →</button>
        <select id="page_size">
          <option value="20">20 / trang</option>
          <option value="50">50 / trang</option>
          <option value="100">100 / trang</option>
        </select>
      </div>
    </div>
  </div>

  <!-- MODAL FEE ADD/EDIT -->
  <div id="modalFee" class="modal">
    <div class="dialog">
      <div class="head">
        <span id="modalFeeTitle">Thêm khoản thu</span>
        <button id="modalFeeClose" class="btn secondary sm">×</button>
      </div>
      <div class="body">
        <div>
          <label>Phòng</label><br/>
          <select id="m_room"></select>
          <div class="hint">Bắt buộc với phí phòng / phí xe.</div>
        </div>
        <div>
          <label>Loại phí</label><br/>
          <select id="m_fee_type">
            <option value="ROOM">Phí phòng</option>
            <option value="PARKING">Phí bãi xe</option>
            <option value="OTHER">Khác</option>
          </select>
        </div>
        <div>
          <label>Tên khoản thu</label><br/>
          <input id="m_fee_name" placeholder="VD: Tiền phòng tháng 12/2025" />
        </div>
        <div>
          <label>Kỳ thu (period)</label><br/>
          <input id="m_period" type="month" />
          <div class="hint">Lưu dạng YYYY-MM, VD: 2025-12.</div>
        </div>
        <div>
          <label>Số lượng</label><br/>
          <input id="m_quantity" type="number" min="0" step="0.01" value="1" />
          <div class="hint">VD: số tháng, kWh, m³...</div>
        </div>
        <div>
          <label>Đơn giá</label><br/>
          <input id="m_unit_price" type="number" min="0" step="0.01" value="0" />
        </div>
        <div>
          <label>Hạn thanh toán</label><br/>
          <input id="m_due_date" type="date" />
        </div>
        <div class="full">
          <label>Tự tính cần thu:</label><br/>
          <div><span id="m_calc_total" class="pill">0 đ</span></div>
          <div class="hint">Hệ thống sẽ tự set <code>amount_due = quantity × unit_price</code> khi lưu.</div>
        </div>
        <div class="full">
          <label>Ghi chú</label><br/>
          <input id="m_note" placeholder="Ghi chú nội bộ" />
        </div>
      </div>
      <div class="foot">
        <button id="m_cancel" class="btn secondary">Hủy</button>
        <button id="m_save" class="btn">Lưu</button>
      </div>
    </div>
  </div>

  <!-- MODAL PAYMENT (THU TIỀN) -->
  <div id="modalPay" class="modal">
    <div class="dialog">
      <div class="head">
        <span id="modalPayTitle">Thu tiền</span>
        <button id="modalPayClose" class="btn secondary sm">×</button>
      </div>
      <div class="body">
        <div class="full">
          <div id="modalPaySummary" class="hint"></div>
        </div>
        <div>
          <label>Số tiền thu</label><br/>
          <input id="p_amount" type="number" min="0" step="0.01" />
        </div>
        <div>
          <label>Phương thức</label><br/>
          <select id="p_method">
            <option value="CASH">Tiền mặt</option>
            <option value="BANK_TRANSFER">Chuyển khoản</option>
            <option value="CARD">Thẻ</option>
            <option value="OTHER">Khác</option>
          </select>
        </div>
        <div class="full">
          <label>Ghi chú</label><br/>
          <input id="p_note" placeholder="Ghi chú giao dịch (nếu có)" />
        </div>
      </div>
      <div class="foot">
        <button id="p_cancel" class="btn secondary">Hủy</button>
        <button id="p_save" class="btn">Ghi nhận</button>
      </div>
    </div>
  </div>

  <!-- MODAL PAYMENT HISTORY -->
  <div id="modalHistory" class="modal">
    <div class="dialog">
      <div class="head">
        <span id="modalHistoryTitle">Lịch sử thanh toán</span>
        <button id="modalHistoryClose" class="btn secondary sm">×</button>
      </div>
      <div class="body full">
        <div class="full">
          <table id="historyTable" class="bordered-table">
            <thead>
              <tr>
                <th>Ngày</th>
                <th>Số tiền</th>
                <th>Phương thức</th>
                <th>Người thu</th>
                <th>Ghi chú</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="historyEmpty" class="hint" style="margin-top:8px; display:none;">Chưa có giao dịch nào.</div>
        </div>
      </div>
      <div class="foot">
        <button id="historyCloseBtn" class="btn secondary">Đóng</button>
      </div>
    </div>
  </div>

  <script>
    const API = location.origin.replace(/\/$/, '') + '/api';
    const el = sel => document.querySelector(sel);

    let state = {
      page: 1,
      page_size: 20,
      q: '',
      fee_type: '',
      status: '',
      period: '',
      room_id: ''
    };
    let roomsCache = [];
    let editingFeeId = null;
    let payingFee = null;

    const fmtMoney = n => new Intl.NumberFormat('vi-VN').format(Number(n || 0)) + ' đ';
    const fmtQty = n => Number(n || 0).toLocaleString('vi-VN', { maximumFractionDigits: 3 });
    const todayISO = () => new Date().toISOString().slice(0, 10);
    const toDateOnly = s => s ? String(s).slice(0, 10) : '';

    document.getElementById('Back').onclick = () => {
      window.location.href = '/admin/home_admin.html';
    };

    async function loadRooms() {
      const res = await fetch(`${API}/rooms?minimal=1`, { credentials: 'include' });
      const data = await res.json();
      roomsCache = Array.isArray(data) ? data : (data.items || []);
      const selFilter = el('#room_filter');
      const selModal = el('#m_room');

      selFilter.innerHTML = '<option value="">Tất cả phòng</option>';
      selModal.innerHTML = '';

      roomsCache.forEach(rm => {
        const label = rm.room_no || rm.name || ('Room ' + rm.id);
        const opt1 = document.createElement('option');
        opt1.value = rm.id;
        opt1.textContent = label;
        selFilter.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = rm.id;
        opt2.textContent = label;
        selModal.appendChild(opt2);
      });
    }

    async function loadFees() {
      const params = new URLSearchParams({
        page: state.page,
        page_size: state.page_size,
        q: state.q,
        fee_type: state.fee_type,
        status: state.status,
        period: state.period,
        room_id: state.room_id
      }).toString();

      const res = await fetch(`${API}/fees?` + params, { credentials: 'include' });
      const data = await res.json();
      if (!data.ok) {
        alert(data.message || 'Load danh sách phí lỗi');
        return;
      }

      el('#total').textContent = `${data.total} bản ghi`;
      const totalPages = Math.max(1, Math.ceil((data.total || 0) / state.page_size));
      el('#pageinfo').textContent = `${state.page} / ${totalPages}`;
      el('#prev').disabled = state.page <= 1;
      el('#next').disabled = state.page >= totalPages;

      const tbody = el('#tbl tbody');
      tbody.innerHTML = '';
      const today = todayISO();
      let idx = (state.page - 1) * state.page_size;

      (data.items || []).forEach(it => {
        idx++;
        const tr = document.createElement('tr');
        tr.className = 'bill-row';
        tr.dataset.feeId = it.id;

        const roomLabel = it.room_no || (it.room_id ? ('Room ' + it.room_id) : '');
        const plate = it.plate || '';
        const dueDate = toDateOnly(it.due_date);
        const createdDate = toDateOnly(it.created_at);
        const period = it.period || '';
        const amountDue = Number(it.amount_due || 0);
        const amountPaid = Number(it.amount_paid != null ? it.amount_paid : (it.paid_sum || 0));
        const remain = Math.max(0, Math.round((amountDue - amountPaid) * 100) / 100);

        const lateBadge = (dueDate && dueDate < today && remain > 0)
          ? `<span class="badge-late">Quá hạn</span>` : '';

        const st = it.status || 'UNPAID';
        const statusBadge = `<span class="badge-status ${st}">${st}</span>`;

        tr.innerHTML = `
          <td>${idx}</td>
          <td>${roomLabel}</td>
          <td>${plate}</td>
          <td>${it.fee_name || ''}</td>
          <td>${it.fee_type || ''}</td>
          <td>${period}</td>
          <td class="text-right">${fmtQty(it.quantity)}</td>
          <td class="text-right">${fmtMoney(it.unit_price)}</td>
          <td class="text-right">${fmtMoney(amountDue)}</td>
          <td class="text-right">${fmtMoney(amountPaid)}</td>
          <td class="text-right">${fmtMoney(remain)}</td>
          <td>${dueDate} ${lateBadge}</td>
          <td>${statusBadge}</td>
          <td>${createdDate}</td>
        `;
        tbody.appendChild(tr);

        // Thêm hàng action (ban đầu ẩn)
        const actionTr = document.createElement('tr');
        actionTr.className = 'action-row';
        actionTr.dataset.feeId = it.id;
        actionTr.style.display = 'none';
        actionTr.innerHTML = `
          <td colspan="14">
            <div class="action-btns">
              <button class="btn secondary sm" data-act="pay" data-id="${it.id}">Thu tiền</button>
              <button class="btn secondary sm" data-act="history" data-id="${it.id}">Lịch sử</button>
              <button class="btn secondary sm" data-act="edit" data-id="${it.id}">Sửa</button>
              <button class="btn secondary sm" data-act="del" data-id="${it.id}">Xóa</button>
            </div>
          </td>
        `;
        tbody.appendChild(actionTr);
      });
    }

    function attachFilters() {
      el('#btnSearch').onclick = () => {
        state.q = el('#q').value.trim();
        state.fee_type = el('#fee_type').value;
        state.status = el('#status').value;
        const periodVal = el('#period').value; // yyyy-MM
        state.period = periodVal || '';
        state.room_id = el('#room_filter').value || '';
        state.page = 1;
        loadFees();
      };
      el('#page_size').onchange = () => {
        state.page_size = Number(el('#page_size').value || 20);
        state.page = 1;
        loadFees();
      };
      el('#prev').onclick = () => {
        state.page = Math.max(1, state.page - 1);
        loadFees();
      };
      el('#next').onclick = () => {
        state.page = state.page + 1;
        loadFees();
      };
    }

    // ====== MODAL FEE (ADD/EDIT) ======
    function openFeeModal(title) {
      el('#modalFeeTitle').textContent = title;
      el('#modalFee').classList.add('show');
    }
    function closeFeeModal() {
      el('#modalFee').classList.remove('show');
      editingFeeId = null;
      clearFeeModal();
    }
    function clearFeeModal() {
      if (roomsCache.length > 0) {
        el('#m_room').value = roomsCache[0].id;
      }
      el('#m_fee_type').value = 'ROOM';
      el('#m_fee_name').value = '';
      el('#m_period').value = '';
      el('#m_quantity').value = '1';
      el('#m_unit_price').value = '0';
      el('#m_due_date').value = todayISO();
      el('#m_note').value = '';
      syncCalcTotal();
    }
    function syncCalcTotal() {
      const q = parseFloat(el('#m_quantity').value || '0');
      const p = parseFloat(el('#m_unit_price').value || '0');
      const calc = (q * p).toFixed(2);
      el('#m_calc_total').textContent = fmtMoney(calc);
    }

    async function loadFeeDetail(id) {
      const res = await fetch(`${API}/fees/${id}`, { credentials: 'include' });
      const data = await res.json();
      if (!data.ok) throw new Error(data.message || 'Không tải được phí');
      const f = data.fee;

      editingFeeId = f.id;
      openFeeModal('Sửa khoản thu');

      if (f.room_id && roomsCache.length > 0) {
        el('#m_room').value = String(f.room_id);
      }
      el('#m_fee_type').value = f.fee_type || 'ROOM';
      el('#m_fee_name').value = f.fee_name || '';
      el('#m_period').value = f.period || '';
      el('#m_quantity').value = f.quantity != null ? f.quantity : 1;
      el('#m_unit_price').value = f.unit_price != null ? f.unit_price : 0;
      el('#m_due_date').value = toDateOnly(f.due_date) || todayISO();
      el('#m_note').value = f.note || '';
      syncCalcTotal();
    }

    function attachFeeModalEvents() {
      el('#btnAdd').onclick = () => {
        clearFeeModal();
        openFeeModal('Thêm khoản thu');
      };
      el('#modalFeeClose').onclick = closeFeeModal;
      el('#m_cancel').onclick = closeFeeModal;
      el('#m_quantity').oninput = syncCalcTotal;
      el('#m_unit_price').oninput = syncCalcTotal;

      el('#m_save').onclick = async () => {
        const room_id = Number(el('#m_room').value || 0) || null;
        const fee_type = el('#m_fee_type').value || 'ROOM';
        const fee_name = el('#m_fee_name').value.trim();
        const periodInput = el('#m_period').value; // yyyy-MM
        const quantity = Number(el('#m_quantity').value || 0);
        const unit_price = Number(el('#m_unit_price').value || 0);
        const due_date = el('#m_due_date').value || null;
        const note = el('#m_note').value.trim() || null;

        if (!fee_name) {
          alert('Vui lòng nhập tên khoản thu');
          return;
        }
        if (!room_id) {
          alert('Vui lòng chọn phòng');
          return;
        }
        if (quantity < 0 || unit_price < 0) {
          alert('Số lượng và đơn giá phải không âm');
          return;
        }

        const body = {
          room_id,
          fee_name,
          fee_type,
          period: periodInput || null,
          quantity,
          unit_price,
          due_date,
          note
        };

        try {
          let res;
          if (editingFeeId) {
            res = await fetch(`${API}/fees/${editingFeeId}`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              credentials: 'include',
              body: JSON.stringify(body)
            });
          } else {
            res = await fetch(`${API}/fees`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              credentials: 'include',
              body: JSON.stringify(body)
            });
          }
          const data = await res.json();
          if (!data.ok) throw new Error(data.message || 'Lỗi lưu khoản thu');
          closeFeeModal();
          loadFees();
        } catch (err) {
          alert(err.message);
        }
      };
    }

    // ====== MODAL PAY (THU TIỀN) ======
    function openPayModal(feeRow) {
      payingFee = feeRow;
      const amountDue = Number(feeRow.amount_due || 0);
      const amountPaid = Number(feeRow.amount_paid != null ? feeRow.amount_paid : (feeRow.paid_sum || 0));
      const remain = Math.max(0, Math.round((amountDue - amountPaid) * 100) / 100);

      el('#modalPaySummary').innerHTML =
        `<span class="text-xs">
          <b>${feeRow.fee_name || ''}</b> – Phòng: ${feeRow.room_no || ('Room ' + (feeRow.room_id || ''))}<br/>
          Cần thu: <b>${fmtMoney(amountDue)}</b>,
          Đã nộp: <b>${fmtMoney(amountPaid)}</b>,
          Còn thiếu: <b>${fmtMoney(remain)}</b>
        </span>`;
      el('#p_amount').value = remain.toFixed(2);
      el('#p_method').value = 'CASH';
      el('#p_note').value = '';
      el('#modalPayTitle').textContent = 'Thu tiền';

      el('#modalPay').classList.add('show');
    }
    function closePayModal() {
      el('#modalPay').classList.remove('show');
      payingFee = null;
    }

    function attachPayModalEvents() {
      el('#modalPayClose').onclick = closePayModal;
      el('#p_cancel').onclick = closePayModal;

      el('#p_save').onclick = async () => {
        if (!payingFee) return;
        const fee_id = payingFee.id;
        const amount = Number(el('#p_amount').value || 0);
        const method = el('#p_method').value || 'CASH';
        const note = el('#p_note').value.trim() || null;

        if (!(amount > 0)) {
          alert('Số tiền thu phải > 0');
          return;
        }

        try {
          // 1. Tạo payment
          const res = await fetch(`${API}/payments`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({ fee_id, amount, method, note })
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.message || 'Lỗi ghi nhận thanh toán');
          
          // 2. Cập nhật fee để amount_paid = amount_due
          const amountDue = Number(payingFee.amount_due || 0);
          await fetch(`${API}/fees/${fee_id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            credentials: 'include',
            body: JSON.stringify({
              amount_paid: amountDue,
              status: 'PAID'
            })
          });
          
          alert('✅ Thanh toán hoàn tất!');
          closePayModal();
          loadFees();
        } catch (err) {
          alert(err.message);
        }
      };
    }

    // ====== MODAL HISTORY ======
    function openHistoryModal() {
      el('#modalHistory').classList.add('show');
    }
    function closeHistoryModal() {
      el('#modalHistory').classList.remove('show');
      const tbody = el('#historyTable tbody');
      tbody.innerHTML = '';
      el('#historyEmpty').style.display = 'none';
    }

    async function loadHistory(feeId, feeTitleForHeader) {
      const res = await fetch(`${API}/fees/${feeId}/payments`, { credentials: 'include' });
      const data = await res.json();
      if (!data.ok) {
        alert(data.message || 'Không tải được lịch sử');
        return;
      }
      el('#modalHistoryTitle').textContent = `Lịch sử thanh toán – ${feeTitleForHeader || ''}`;

      const tbody = el('#historyTable tbody');
      tbody.innerHTML = '';
      const rows = data.payments || [];
      if (rows.length === 0) {
        el('#historyEmpty').style.display = 'block';
      } else {
        el('#historyEmpty').style.display = 'none';
        rows.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${toDateOnly(p.payment_date)}</td>
            <td class="text-right">${fmtMoney(p.amount)}</td>
            <td>${p.method || ''}</td>
            <td>${p.created_by_name || ''}</td>
            <td>${p.note || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      openHistoryModal();
    }

    function attachHistoryModalEvents() {
      el('#modalHistoryClose').onclick = closeHistoryModal;
      el('#historyCloseBtn').onclick = closeHistoryModal;
    }

    // ====== TABLE ROW ACTIONS ======
    function attachRowActions() {
      // Click vào hàng để toggle action row
      el('#tbl tbody').addEventListener('click', (ev) => {
        const billRow = ev.target.closest('.bill-row');
        if (billRow) {
          const feeId = billRow.dataset.feeId;
          const actionRow = document.querySelector(`.action-row[data-fee-id="${feeId}"]`);
          
          // Đóng tất cả action rows khác
          document.querySelectorAll('.action-row').forEach(row => {
            if (row.dataset.feeId !== feeId) {
              row.style.display = 'none';
            }
          });
          document.querySelectorAll('.bill-row').forEach(row => {
            if (row.dataset.feeId !== feeId) {
              row.classList.remove('active');
            }
          });
          
          // Toggle current action row
          if (actionRow.style.display === 'none') {
            actionRow.style.display = '';
            billRow.classList.add('active');
          } else {
            actionRow.style.display = 'none';
            billRow.classList.remove('active');
          }
          return;
        }
      });

      // Xử lý click các nút action
      el('#tbl').addEventListener('click', async (ev) => {
        const btn = ev.target.closest('button[data-act]');
        if (!btn) return;
        const id = Number(btn.dataset.id);
        const act = btn.dataset.act;

        if (act === 'del') {
          if (!confirm('Xóa khoản thu này? Tất cả giao dịch liên quan cũng sẽ bị xóa.')) return;
          const res = await fetch(`${API}/fees/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const data = await res.json();
          if (!data.ok) {
            alert(data.message || 'Lỗi xóa');
            return;
          }
          loadFees();
        }

        if (act === 'edit') {
          try {
            await loadFeeDetail(id);
          } catch (err) {
            alert(err.message);
          }
        }

        if (act === 'pay') {
          try {
            // lấy lại chi tiết fee để tính chính xác
            const res = await fetch(`${API}/fees/${id}`, { credentials: 'include' });
            const data = await res.json();
            if (!data.ok) throw new Error(data.message || 'Không tải được phí');
            const f = data.fee;
            openPayModal(f);
          } catch (err) {
            alert(err.message);
          }
        }

        if (act === 'history') {
          try {
            const res = await fetch(`${API}/fees/${id}`, { credentials: 'include' });
            const data = await res.json();
            if (!data.ok) throw new Error(data.message || 'Không tải được phí');
            const f = data.fee;
            await loadHistory(id, f.fee_name || '');
          } catch (err) {
            alert(err.message);
          }
        }
      });
    }

    // ====== INIT ======
    (async function init() {
      el('#page_size').value = String(state.page_size);
      await loadRooms();
      attachFilters();
      attachFeeModalEvents();
      attachPayModalEvents();
      attachHistoryModalEvents();
      attachRowActions();
      el('#m_due_date').value = todayISO();
      loadFees();
    })();
  </script>
</body>
</html>
