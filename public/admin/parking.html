<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlueMoon ‚Äî Th·∫ª xe & B√£i ƒë·∫≠u</title>
  <style>
    :root{
      --bg-grad-start:#3b82f6; --bg-grad-end:#1e3a8a;
      --text:#0b1226; --muted:#56607a; --card:#ffffff; --stroke:#e6eaf5;
      --toolbar-h:64px; --radius:18px;
      --shadow:0 18px 45px rgba(13,35,69,.18);
      --shadow-2:0 10px 28px rgba(13,35,69,.16);
    }
    [data-theme="dark"]{
      --bg-grad-start:#0f172a; --bg-grad-end:#0b1220;
      --text:#e5e7eb; --muted:#a3adc2; --card:#0b1226; --stroke:#1f2a44;
      --shadow:0 18px 45px rgba(0,0,0,.45); --shadow-2:0 10px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{
      color:var(--text);
      background: radial-gradient(1200px 800px at 70% 15%, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
      overflow-x:hidden;
    }

    .toolbar{
      position:fixed; inset:0 0 auto 0; height:var(--toolbar-h);
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
      padding:0 16px; z-index:20; color:#fff;
      background:linear-gradient(180deg,rgba(0,0,0,.18),rgba(0,0,0,.08));
      backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,.18);
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:999px; cursor:pointer;
      background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.18);
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }

    .main{min-height:100%; padding-top:calc(var(--toolbar-h) + 28px); padding-bottom:40px;}
    .container{width:min(980px,92vw); margin:0 auto;}
    .title{margin:8px 0 18px; font-size:34px; font-weight:900; letter-spacing:.2px; color:#fff;}

    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow-2);
      padding:20px; margin-bottom:16px;
    }
    h2{margin:0 0 12px; font-size:20px; color:var(--text)}
    h3{margin:0 0 8px; font-size:16px; color:var(--text)}
    p{margin:6px 0; color:var(--muted)}

    .tabs{
      display:flex; gap:4px; margin-bottom:20px; background:var(--stroke); border-radius:12px; padding:4px;
    }
    .tab{
      flex:1; padding:8px 16px; border-radius:8px; text-align:center; cursor:pointer;
      font-weight:600; transition:all .2s ease; border:none; background:transparent; color:var(--muted);
    }z
    .tab.active{background:var(--card); color:var(--text); box-shadow:var(--shadow-2)}

    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:12px; border:1px solid var(--stroke);
      background:var(--card); cursor:pointer; box-shadow:var(--shadow-2); text-decoration:none; color:inherit;
      font-weight:600; transition:transform .1s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:#2563eb; color:#fff; border-color:#2563eb}
    .btn.success{background:#16a34a; color:#fff; border-color:#16a34a}
    .btn.warning{background:#f59e0b; color:#fff; border-color:#f59e0b}
    .btn.danger{background:#ef4444; color:#fff; border-color:#ef4444}

    .form-group{margin-bottom:16px}
    .form-label{display:block; margin-bottom:6px; font-weight:600; color:var(--text)}
    .form-control{
      width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:8px;
      background:var(--card); color:var(--text); font-family:inherit;
    }
    .form-control:focus{outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    .form-row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 640px){.form-row{grid-template-columns:1fr}}

    .vehicle-card{
      border:1px solid var(--stroke); border-radius:12px; padding:16px; margin-bottom:12px;
      transition:box-shadow .2s ease; background:var(--card);
    }
    .vehicle-card:hover{box-shadow:var(--shadow-2)}
    .vehicle-header{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px}
    .vehicle-info h3{margin:0; color:var(--text)}
    .vehicle-info p{margin:0; color:var(--muted); font-size:14px}
    .vehicle-status{
      padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600;
    }
    .status-in{background:#dcfce7; color:#166534}
    .status-out{background:#fef3c7; color:#92400e}
    [data-theme="dark"] .status-in{background:#052e16; color:#4ade80}
    [data-theme="dark"] .status-out{background:#451a03; color:#fbbf24}

    .vehicle-details{display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:6px; margin:8px 0 10px}
    .detail-item{display:flex; align-items:center; gap:6px; color:var(--text); font-size:13px}

    .parking-grid{
      display:grid; grid-template-columns:repeat(auto-fill,minmax(70px,1fr)); gap:8px; margin:16px 0;
    }
    .parking-spot{
      aspect-ratio:1; border:2px solid var(--stroke); border-radius:8px; display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:12px;
    }
    .spot-occupied{background:#fef2f2; color:#dc2626; border-color:#ef4444}
    [data-theme="dark"] .spot-occupied{background:#450a0a; color:#f87171; border-color:#ef4444}

    .stats{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:12px; margin-top:12px}
    .stat-item{text-align:center; padding:12px; background:var(--card); border:1px solid var(--stroke); border-radius:8px}
    .stat-number{font-size:22px; font-weight:800; color:var(--text)}
    .stat-label{font-size:12px; color:var(--muted); margin-top:4px}

    .history-row{
      border-bottom:1px solid var(--stroke); padding:10px 0; display:grid;
      grid-template-columns:2fr 1fr 1fr 1fr; gap:8px; font-size:14px; align-items:center;
    }
    @media (max-width: 720px){
      .tabs{flex-direction:column}
      .history-row{grid-template-columns:1fr; align-items:flex-start}
    }
    .badge{
      display:inline-flex; padding:4px 8px; border-radius:99px; font-size:11px; font-weight:600;
    }
    .badge-unpaid{background:#fef2f2;color:#b91c1c}
    .badge-partial{background:#fef3c7;color:#92400e}
    .badge-paid{background:#dcfce7;color:#166534}
    .badge-cancelled{background:#e5e7eb;color:#374151}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
    .modal.active{display:flex}
    .modal-content{width:min(500px,90vw);background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--stroke);display:flex;justify-content:space-between;align-items:center}
    .modal-header h3{margin:0;font-size:18px}
    .modal-body{padding:20px}
    .modal-footer{padding:16px 20px;border-top:1px solid var(--stroke);display:flex;gap:8px;justify-content:flex-end}
    .payment-method-grid{display:grid;gap:12px;margin-top:12px}
    .payment-method-btn{padding:16px;border:2px solid var(--stroke);border-radius:12px;background:var(--card);cursor:pointer;text-align:center;transition:all .2s ease}
    .payment-method-btn:hover{border-color:#3b82f6;background:#eff6ff}
    .payment-method-btn.selected{border-color:#3b82f6;background:#dbeafe}
    [data-theme="dark"] .payment-method-btn:hover{background:#1e3a8a}
    [data-theme="dark"] .payment-method-btn.selected{background:#1e40af}
  </style>
</head>
<body>
  <script>
    // Ki·ªÉm tra authentication ngay l·∫≠p t·ª©c
    (function() {
      const SESSION_KEY = 'bluemoon_session';
      try {
        const data = localStorage.getItem(SESSION_KEY);
        if (!data) {
          window.location.href = '/index.html';
          return;
        }
        const session = JSON.parse(data);
        const maxAge = 8 * 60 * 60 * 1000;
        if (Date.now() - session.timestamp > maxAge) {
          localStorage.removeItem(SESSION_KEY);
          window.location.href = '/index.html';
          return;
        }
        if (session.role !== 'ADMIN') {
          alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
          window.location.href = '/index.html';
          return;
        }
      } catch (e) {
        window.location.href = '/index.html';
      }
    })();
  </script>
  <!-- Modal thanh to√°n -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üí≥ Thanh to√°n ph√≠ xe</h3>
        <button class="btn" onclick="closePaymentModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <p style="color:var(--muted);margin-bottom:16px" id="paymentInfo">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</p>
        <div class="payment-method-grid">
          <div class="payment-method-btn" data-method="BANK_TRANSFER" onclick="selectPaymentMethod('BANK_TRANSFER')">
            <div style="font-size:32px;margin-bottom:8px">üè¶</div>
            <div style="font-weight:600">Chuy·ªÉn kho·∫£n</div>
          </div>
          <div class="payment-method-btn" data-method="CARD" onclick="selectPaymentMethod('CARD')">
            <div style="font-size:32px;margin-bottom:8px">üí≥</div>
            <div style="font-weight:600">Th·∫ª t√≠n d·ª•ng</div>
          </div>
          <div class="payment-method-btn" data-method="CASH" onclick="selectPaymentMethod('CASH')">
            <div style="font-size:32px;margin-bottom:8px">üíµ</div>
            <div style="font-weight:600">Ti·ªÅn m·∫∑t</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closePaymentModal()">H·ªßy</button>
        <button class="btn success" id="confirmPaymentBtn" onclick="confirmPayment()" disabled>X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </div>
  </div>
  <!-- Toolbar -->
  <header class="toolbar" role="banner">
    <button class="icon-btn" id="btnBack">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
    <div></div>
    <button class="icon-btn" id="btnNotifications">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 22a2.5 2.5 0 0 0 2.4-2H9.6A2.5 2.5 0 0 0 12 22Z" fill="white" opacity=".9"/>
        <path d="M19 17H5l1.2-1.8A2 2 0 0 0 7 14v-3a5 5 0 1 1 10 0v3c0 .4.1.8.3 1.2L19 17Z" stroke="white" stroke-width="1.8" fill="none" opacity=".9"/>
      </svg>
    </button>
  </header>

  <main class="main">
    <div class="container">
      <h1 class="title">Th·∫ª xe & B√£i ƒë·∫≠u</h1>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="vehicles" onclick="showTab('vehicles', event)">üöó Ph∆∞∆°ng ti·ªán</button>
        <button class="tab" data-tab="parking" onclick="showTab('parking', event)">üÖøÔ∏è B√£i ƒë·∫≠u</button>
        <button class="tab" data-tab="register" onclick="showTab('register', event)">üìù ƒêƒÉng k√Ω</button>
        <button class="tab" data-tab="history" onclick="showTab('history', event)">üìã L·ªãch s·ª≠</button>
      </div>

      <!-- VEHICLES TAB -->
      <div id="tab-vehicles" class="tab-content">
        <section class="card">
          <h2>üöó Ph∆∞∆°ng ti·ªán ƒë√£ ƒëƒÉng k√Ω</h2>

          <!-- Filters -->
          <div class="form-row" style="margin-bottom:12px">
            <div class="form-group">
              <label class="form-label">T·ª´ kh√≥a (bi·ªÉn s·ªë / h√£ng / model)</label>
              <input id="searchQ" type="text" class="form-control" placeholder="VD: 29A, Honda, Vision...">
            </div>
            <div class="form-row" style="gap:8px; margin-top:4px">
              <div class="form-group">
                <label class="form-label">Tr·∫°ng th√°i b√£i ƒë·∫≠u</label>
                <select id="filterParkingStatus" class="form-control">
                  <option value="">T·∫•t c·∫£</option>
                  <option value="IN">ƒêang trong b√£i</option>
                  <option value="OUT">Kh√¥ng trong b√£i</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Lo·∫°i xe</label>
                <select id="filterVehicleType" class="form-control">
                  <option value="">T·∫•t c·∫£</option>
                  <option value="CAR">√î t√¥</option>
                  <option value="MOTORBIKE">Xe m√°y</option>
                  <option value="BICYCLE">Xe ƒë·∫°p</option>
                  <option value="OTHER">Kh√°c</option>
                </select>
              </div>
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-bottom:12px">
            <button class="btn" onclick="reloadVehicles()">üîç T√¨m ki·∫øm</button>
            <button class="btn primary" onclick="showTab('register')">‚ûï ƒêƒÉng k√Ω xe m·ªõi</button>
          </div>

          <div id="vehiclesList">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              ‚è≥ ƒêang t·∫£i danh s√°ch ph∆∞∆°ng ti·ªán...
            </div>
          </div>
        </section>
      </div>

      <!-- PARKING TAB -->
      <div id="tab-parking" class="tab-content" style="display:none">
        <section class="card">
          <h2>üÖøÔ∏è S∆° ƒë·ªì b√£i ƒë·∫≠u (xe ƒëang trong b√£i)</h2>
          <p>Danh s√°ch c√°c ch·ªó ƒë·∫≠u hi·ªán c√≥ xe (parking_status = IN). B·∫•m v√†o xe ƒë·ªÉ xem chi ti·∫øt.</p>

          <div id="parkingGridWrapper">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              ‚è≥ ƒêang t·∫£i d·ªØ li·ªáu b√£i ƒë·∫≠u...
            </div>
          </div>
        </section>

        <section class="card">
          <h2>üìä Th·ªëng k√™ ph√≠ g·ª≠i xe</h2>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">T·ª´ ng√†y</label>
              <input type="date" id="statFrom" class="form-control">
            </div>
            <div class="form-group">
              <label class="form-label">ƒê·∫øn ng√†y</label>
              <input type="date" id="statTo" class="form-control">
            </div>
          </div>
          <button class="btn" onclick="reloadParkingStats()">üìà Xem th·ªëng k√™</button>

          <div class="stats" id="parkingStats">
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">T·ªïng ph√≠ ph·∫£i thu</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">ƒê√£ thanh to√°n</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">Ch∆∞a thanh to√°n</div>
            </div>
            <div class="stat-item">
              <div class="stat-number">--</div>
              <div class="stat-label">S·ªë kho·∫£n ph√≠</div>
            </div>
          </div>
        </section>
      </div>

      <!-- REGISTER TAB -->
      <div id="tab-register" class="tab-content" style="display:none">
        <section class="card">
          <h2>üìù ƒêƒÉng k√Ω ph∆∞∆°ng ti·ªán m·ªõi</h2>
          <form id="vehicleForm">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">CƒÉn h·ªô</label>
                <select id="roomSelect" class="form-control" required>
                  <option value="">-- Ch·ªçn cƒÉn h·ªô --</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Ch·ªß s·ªü h·ªØu (nh√¢n kh·∫©u)</label>
                <select id="personSelect" class="form-control">
                  <option value="">-- Ch·ªçn ch·ªß xe --</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Lo·∫°i ph∆∞∆°ng ti·ªán</label>
              <select class="form-control" id="vehicleType" required>
                <option value="">-- Ch·ªçn lo·∫°i xe --</option>
                <option value="CAR">√î t√¥</option>
                <option value="MOTORBIKE">Xe m√°y</option>
                <option value="BICYCLE">Xe ƒë·∫°p</option>
                <option value="OTHER">Kh√°c</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Bi·ªÉn s·ªë xe</label>
                <input type="text" class="form-control" id="licensePlate" placeholder="VD: 29A-12345" required>
              </div>
              <div class="form-group">
                <label class="form-label">M√†u s·∫Øc</label>
                <input type="text" class="form-control" id="vehicleColor" placeholder="Tr·∫Øng, ƒêen..." >
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label">H√£ng xe</label>
                <input type="text" class="form-control" id="vehicleBrand" placeholder="Honda, Toyota..." >
              </div>
              <div class="form-group">
                <label class="form-label">Model</label>
                <input type="text" class="form-control" id="vehicleModel" placeholder="Vision, City..." >
              </div>
            </div>

            <div style="display:flex; gap:12px; margin-top:20px">
              <button type="submit" class="btn primary">üìù ƒêƒÉng k√Ω</button>
              <button type="reset" class="btn">üîÑ L√†m m·ªõi</button>
            </div>
          </form>
        </section>
      </div>

      <!-- HISTORY TAB -->
      <div id="tab-history" class="tab-content" style="display:none">
        <section class="card">
          <h2>üìã L·ªãch s·ª≠ ph√≠ g·ª≠i xe</h2>
          <p>Danh s√°ch c√°c kho·∫£n ph√≠ c√≥ <b>fee_type = 'PARKING'</b>.</p>

          <div id="historyList">
            <div style="text-align:center; padding:20px; color:var(--muted)">
              ‚è≥ ƒêang t·∫£i l·ªãch s·ª≠...
            </div>
          </div>
        </section>
      </div>

      <div style="margin-top:20px; text-align:center">
        <a href="/admin/dashboard.html" class="btn">‚Üê V·ªÅ trang ch·ªß</a>
      </div>
    </div>
  </main>

  <script>
    // API base (s·ª≠ d·ª•ng relative path ƒë·ªÉ d√πng chung domain v·ªõi backend)
    const API_BASE = '/api';

    let vehiclesData = [];
    let parkingVehicles = [];
    let parkingStats = null;
    let feesData = [];
    let roomsCache = [];
    let personsByRoom = {};

    // Theme
    const theme = localStorage.getItem('bm_theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);

    // Toolbar events
    document.getElementById('btnBack').addEventListener('click', () => {
      window.location.href = '/admin/dashboard.html';
    });
    document.getElementById('btnNotifications').addEventListener('click', () => {
      alert('Th√¥ng b√°o: Vui l√≤ng ki·ªÉm tra c√°c kho·∫£n ph√≠ g·ª≠i xe UNPAID.');
    });

    // Helpers
    function formatDate(d){
      if (!d) return '-';
      const dt = new Date(d);
      return dt.toLocaleDateString('vi-VN');
    }
    function formatMoney(x){
      if (x == null) return '0ƒë';
      return new Intl.NumberFormat('vi-VN').format(Number(x)) + 'ƒë';
    }

    // Tabs
    function showTab(name, ev){
      document.querySelectorAll('.tab-content').forEach(el => el.style.display='none');
      document.getElementById('tab-' + name).style.display = 'block';
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const btn = ev?.currentTarget || document.querySelector(`.tab[data-tab="${name}"]`);
      if (btn) btn.classList.add('active');

      if (name === 'vehicles') reloadVehicles();
      if (name === 'parking') { loadParkingTab(); }
      if (name === 'register') { loadRoomsIfNeeded(); }
      if (name === 'history') { loadFees(); }
    }

    // VEHICLES
    async function reloadVehicles(){
      const q = document.getElementById('searchQ').value.trim();
      const parking_status = document.getElementById('filterParkingStatus').value;
      const vehicle_type = document.getElementById('filterVehicleType').value;

      let url = `${API_BASE}/vehicles?`;
      const params = [];
      if (q) params.push('q=' + encodeURIComponent(q));
      if (parking_status) params.push('parking_status=' + encodeURIComponent(parking_status));
      if (vehicle_type) params.push('vehicle_type=' + encodeURIComponent(vehicle_type)); // n·∫øu ƒë√£ th√™m param n√†y
      url += params.join('&');

      const container = document.getElementById('vehiclesList');
      container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted)">‚è≥ ƒêang t·∫£i...</div>`;

      try{
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok || !data.ok){
          throw new Error(data.message || 'Error');
        }
        vehiclesData = data.vehicles || [];
        renderVehicles();
      }catch(e){
        console.error(e);
        container.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444">‚ùå L·ªói t·∫£i danh s√°ch ph∆∞∆°ng ti·ªán</div>`;
      }
    }

    function renderVehicles(){
      const container = document.getElementById('vehiclesList');
      if (!vehiclesData.length){
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--muted)">
            üìù Ch∆∞a c√≥ ph∆∞∆°ng ti·ªán n√†o.  
            <br><button class="btn primary" style="margin-top:10px" onclick="showTab('register')">‚ûï ƒêƒÉng k√Ω xe ƒë·∫ßu ti√™n</button>
          </div>`;
        return;
      }

      container.innerHTML = vehiclesData.map(v => {
        const icon = v.vehicle_type === 'CAR' ? 'üöó' :
                     v.vehicle_type === 'MOTORBIKE' ? 'üèçÔ∏è' :
                     v.vehicle_type === 'BICYCLE' ? 'üö≤' : 'üöò';
        const statusClass = v.parking_status === 'IN' ? 'status-in' : 'status-out';
        const statusText = v.parking_status === 'IN' ? 'ƒêang trong b√£i' : 'Kh√¥ng trong b√£i';

        return `
        <div class="vehicle-card">
          <div class="vehicle-header">
            <div class="vehicle-info">
              <h3>${icon} ${v.plate}</h3>
              <p>${v.brand || ''} ${v.model || ''}</p>
              <p>${v.owner_name ? `Ch·ªß xe: ${v.owner_name}` : ''}${v.room_no ? ` ‚Ä¢ CƒÉn h·ªô: ${v.room_no}` : ''}</p>
            </div>
            <span class="vehicle-status ${statusClass}">${statusText}</span>
          </div>
          <div class="vehicle-details">
            <div class="detail-item"><span>üÜî</span><span>ID: ${v.id}</span></div>
            <div class="detail-item"><span>üÖøÔ∏è</span><span>Ch·ªó ƒë·∫≠u: ${v.parking_slot || '-'}</span></div>
            <div class="detail-item"><span>üì•</span><span>L·∫ßn v√†o g·∫ßn nh·∫•t: ${formatDate(v.last_checkin)}</span></div>
            <div class="detail-item"><span>üì§</span><span>L·∫ßn ra g·∫ßn nh·∫•t: ${formatDate(v.last_checkout)}</span></div>
            <div class="detail-item"><span>üí∞</span><span>T·ªïng ph√≠ ƒë√£ t√≠nh: ${formatMoney(v.parking_fee_total)}</span></div>
            <div class="detail-item"><span>üìÖ</span><span>Ng√†y ƒëƒÉng k√Ω: ${formatDate(v.created_at)}</span></div>
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px">
            ${v.parking_status === 'OUT'
              ? `<button class="btn success" onclick="checkinVehicle(${v.id})">üÖøÔ∏è Th√™m v√†o b√£i</button>`
              : `<button class="btn warning" onclick="checkoutVehicle(${v.id})">üö™ Cho ra b√£i</button>`}
            <button class="btn danger" onclick="deleteVehicle(${v.id})">üóëÔ∏è X√≥a</button>
          </div>
        </div>`;
      }).join('');
    }

    async function viewVehicleDetail(id){
      try{
        const res = await fetch(`${API_BASE}/vehicles/${id}`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        const v = data.vehicle;
        alert(
          `Chi ti·∫øt ph∆∞∆°ng ti·ªán #${v.id}\n\n` +
          `Bi·ªÉn s·ªë: ${v.plate}\n` +
          `Lo·∫°i: ${v.vehicle_type}\n` +
          `M√†u: ${v.color || '-'}\n` +
          `H√£ng/Model: ${v.brand || ''} ${v.model || ''}\n` +
          `Ch·ªß xe: ${v.owner_name || '-'}\n` +
          `CƒÉn h·ªô: ${v.room_no || '-'}\n` +
          `Tr·∫°ng th√°i b√£i ƒë·∫≠u: ${v.parking_status}\n` +
          `Ch·ªó ƒë·∫≠u: ${v.parking_slot || '-'}`
        );
      }catch(e){
        alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c chi ti·∫øt xe.');
      }
    }

    async function checkinVehicle(id){
      try{
        // L·∫•y th√¥ng tin xe ƒë·ªÉ bi·∫øt lo·∫°i xe
        const vehicleRes = await fetch(`${API_BASE}/vehicles/${id}`);
        const vehicleData = await vehicleRes.json();
        if (!vehicleRes.ok || !vehicleData.ok) throw new Error('Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin xe');
        
        const vehicle = vehicleData.vehicle;
        const isCar = vehicle.vehicle_type === 'CAR' || vehicle.vehicle_type === '√¥_t√¥';
        
        let slot = null;
        let isValid = false;
        
        while (!isValid) {
          slot = prompt(
            isCar 
              ? 'Nh·∫≠p ch·ªó ƒë·∫≠u xe √îT√î (ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ C, VD: C40):'
              : 'Nh·∫≠p ch·ªó ƒë·∫≠u xe (ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ T, VD: T15):'
          );
          
          if (slot === null) return; // User cancelled
          
          slot = slot.trim().toUpperCase();
          
          // Validate
          if (isCar) {
            if (slot.startsWith('C')) {
              isValid = true;
            } else {
              alert('‚ùå Ch·ªó ƒë·∫≠u √îT√î ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ C (VD: C40). Vui l√≤ng nh·∫≠p l·∫°i!');
            }
          } else {
            if (slot.startsWith('T')) {
              isValid = true;
            } else {
              alert('‚ùå Ch·ªó ƒë·∫≠u XE M√ÅY/XE ƒê·∫†P ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ T (VD: T15). Vui l√≤ng nh·∫≠p l·∫°i!');
            }
          }
        }

        const res = await fetch(`${API_BASE}/vehicles/${id}/checkin`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({parking_slot:slot})
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        alert('‚úÖ ƒê√£ th√™m xe v√†o b√£i ƒë·∫≠u.');
        reloadVehicles();
      }catch(e){
        alert('‚ùå L·ªói khi th√™m xe v√†o b√£i: ' + (e.message || ''));
      }
    }

    async function checkoutVehicle(id){
      const unit = prompt('Nh·∫≠p ƒë∆°n gi√° g·ª≠i xe (ƒë·ªìng):', '0');
      if (unit === null) return;
      const qty = prompt('Nh·∫≠p s·ªë l∆∞·ª£ng (gi·ªù/ng√†y/th√°ng...):', '1');
      if (qty === null) return;

      try{
        const res = await fetch(`${API_BASE}/vehicles/${id}/checkout`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            fee_name:'Ph√≠ g·ª≠i xe',
            unit_price:Number(unit),
            quantity:Number(qty)
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        alert(`‚úÖ ƒê√£ cho xe ra kh·ªèi b√£i. T·∫°o kho·∫£n ph√≠ #${data.fee.id} s·ªë ti·ªÅn ${formatMoney(data.fee.amount_due)}`);
        reloadVehicles();
      }catch(e){
        alert('‚ùå L·ªói khi cho xe ra kh·ªèi b√£i: ' + (e.message || ''));
      }
    }

    async function deleteVehicle(id){
      if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ph∆∞∆°ng ti·ªán n√†y?')) return;
      try{
        const res = await fetch(`${API_BASE}/vehicles/${id}`, {method:'DELETE'});
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        alert('‚úÖ ƒê√£ x√≥a ph∆∞∆°ng ti·ªán.');
        reloadVehicles();
      }catch(e){
        alert('‚ùå Kh√¥ng x√≥a ƒë∆∞·ª£c xe: ' + (e.message || ''));
      }
    }

    // PARKING TAB
    async function loadParkingTab(){
      loadParkingVehicles();
      initStatsDefaultRange();
      reloadParkingStats();
    }

    async function loadParkingVehicles(){
      const container = document.getElementById('parkingGridWrapper');
      container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted)">‚è≥ ƒêang t·∫£i...</div>`;
      try{
        // n·∫øu ƒë√£ th√™m /api/parking/vehicles-in-lot th√¨ d√πng endpoint n√†y
        const res = await fetch(`${API_BASE}/parking/vehicles-in-lot`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        parkingVehicles = data.vehicles || [];
      }catch(e){
        // fallback n·∫øu ch∆∞a c√≥ endpoint m·ªõi: l·∫•y t·ª´ /api/vehicles?parking_status=IN
        try{
          const res2 = await fetch(`${API_BASE}/vehicles?parking_status=IN`);
          const data2 = await res2.json();
          if (res2.ok && data2.ok) parkingVehicles = data2.vehicles || [];
          else parkingVehicles = [];
        }catch{}
      }
      renderParkingGrid();
    }

    function renderParkingGrid(){
      const container = document.getElementById('parkingGridWrapper');
      if (!parkingVehicles.length){
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--muted)">
            Hi·ªán kh√¥ng c√≥ xe n√†o trong b√£i.
          </div>`;
        return;
      }

      // nh√≥m theo parking_slot
      const bySlot = {};
      parkingVehicles.forEach(v => {
        const slot = v.parking_slot || '(kh√¥ng r√µ)';
        if (!bySlot[slot]) bySlot[slot] = [];
        bySlot[slot].push(v);
      });

      const slots = Object.keys(bySlot).sort();
      container.innerHTML = `
        <div class="parking-grid">
          ${slots.map(slot => {
            const list = bySlot[slot];
            const label = slot;
            const tooltip = list.map(v => `${v.plate} - ${v.brand || ''} ${v.model || ''}`).join(' | ');
            return `
              <div class="parking-spot spot-occupied" title="${tooltip}"
                   onclick="viewParkingSlot('${slot.replace(/'/g, "\\'")}')">
                ${label}
              </div>`;
          }).join('')}
        </div>
      `;
    }

    function viewParkingSlot(slot){
      const list = parkingVehicles.filter(v => (v.parking_slot || '(kh√¥ng r√µ)') === slot);
      alert(
        `Ch·ªó ƒë·∫≠u ${slot} ƒëang c√≥ ${list.length} xe:\n` +
        list.map(v => `- ${v.plate} (${v.brand || ''} ${v.model || ''})`).join('\n')
      );
    }

    function initStatsDefaultRange(){
      const to = new Date();
      const from = new Date();
      from.setDate(to.getDate() - 30);
      document.getElementById('statTo').value = to.toISOString().slice(0,10);
      document.getElementById('statFrom').value = from.toISOString().slice(0,10);
    }

    async function reloadParkingStats(){
      const from = document.getElementById('statFrom').value;
      const to = document.getElementById('statTo').value;
      const container = document.getElementById('parkingStats');
      container.querySelectorAll('.stat-number').forEach(el => el.textContent = '...');

      try{
        const res = await fetch(`${API_BASE}/parking/statistics?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        const summary = data.summary || {};
        const total_due  = summary.total_amount_due || 0;
        const total_paid = summary.total_amount_paid || 0;
        const unpaid = total_due - total_paid;
        const total_fees = summary.total_fees || 0;

        const numbers = container.querySelectorAll('.stat-number');
        numbers[0].textContent = formatMoney(total_due);
        numbers[1].textContent = formatMoney(total_paid);
        numbers[2].textContent = formatMoney(unpaid);
        numbers[3].textContent = total_fees;
      }catch(e){
        container.innerHTML = `<div style="text-align:center; padding:16px; color:#ef4444">Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªëng k√™.</div>`;
      }
    }

    // REGISTER TAB
    async function loadRoomsIfNeeded(){
      if (roomsCache.length) return;
      try{
        const res = await fetch(`${API_BASE}/rooms`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Error');
        roomsCache = Array.isArray(data) ? data : (data.rooms || []);
        const sel = document.getElementById('roomSelect');
        roomsCache.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.id;
          opt.textContent = `${r.room_no} (${r.room_type || ''})`;
          sel.appendChild(opt);
        });
      }catch(e){
        console.error(e);
        alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch cƒÉn h·ªô.');
      }
    }

    document.getElementById('roomSelect').addEventListener('change', async (ev)=>{
      const roomId = ev.target.value;
      const sel = document.getElementById('personSelect');
      sel.innerHTML = `<option value="">-- Ch·ªçn ch·ªß xe --</option>`;
      if (!roomId) return;
      if (personsByRoom[roomId]){
        fillPersons(roomId);
        return;
      }
      try{
        const res = await fetch(`${API_BASE}/rooms/${roomId}/persons`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        personsByRoom[roomId] = data.persons || [];
        fillPersons(roomId);
      }catch(e){
        console.error(e);
        alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch nh√¢n kh·∫©u.');
      }
    });

    function fillPersons(roomId){
      const sel = document.getElementById('personSelect');
      sel.innerHTML = `<option value="">-- Ch·ªçn ch·ªß xe --</option>`;
      (personsByRoom[roomId] || []).forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.full_name} (${p.relation || ''})`;
        sel.appendChild(opt);
      });
    }

    document.getElementById('vehicleForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const room_id = document.getElementById('roomSelect').value;
      const person_id = document.getElementById('personSelect').value || null;
      const vehicle_type = document.getElementById('vehicleType').value;
      const plate = document.getElementById('licensePlate').value.trim();
      const color = document.getElementById('vehicleColor').value.trim() || null;
      const brand = document.getElementById('vehicleBrand').value.trim() || null;
      const model = document.getElementById('vehicleModel').value.trim() || null;

      if (!room_id || !plate || !vehicle_type){
        alert('Vui l√≤ng ch·ªçn cƒÉn h·ªô, lo·∫°i xe v√† nh·∫≠p bi·ªÉn s·ªë.');
        return;
      }

      try{
        const res = await fetch(`${API_BASE}/vehicles`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            room_id,
            person_id,
            plate,
            vehicle_type,
            brand,
            model,
            color
          })
        });
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');

        alert('‚úÖ ƒêƒÉng k√Ω ph∆∞∆°ng ti·ªán th√†nh c√¥ng.');
        e.target.reset();
        vehiclesData = [];
        showTab('vehicles');
      }catch(err){
        alert('‚ùå Kh√¥ng ƒëƒÉng k√Ω ƒë∆∞·ª£c xe: ' + (err.message || ''));
      }
    });

    // HISTORY TAB
    async function loadFees(){
      const container = document.getElementById('historyList');
      container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted)">‚è≥ ƒêang t·∫£i...</div>`;
      try{
        const res = await fetch(`${API_BASE}/fees?fee_type=PARKING&page=1&page_size=50`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        feesData = data.items || [];
        renderFees();
      }catch(e){
        console.error(e);
        container.innerHTML = `<div style="text-align:center; padding:20px; color:#ef4444">‚ùå L·ªói t·∫£i l·ªãch s·ª≠ ph√≠ g·ª≠i xe</div>`;
      }
    }

    function renderFees(){
      const container = document.getElementById('historyList');
      if (!feesData.length){
        container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted)">Ch∆∞a ph√°t sinh ph√≠ g·ª≠i xe.</div>`;
        return;
      }
      container.innerHTML = feesData.map(f=>{
        const badgeClass =
          f.status === 'PAID' ? 'badge-paid' :
          f.status === 'PARTIAL' ? 'badge-partial' :
          f.status === 'CANCELLED' ? 'badge-cancelled' :
          'badge-unpaid';
        const plate = f.plate || '-';
        return `
          <div class="history-row">
            <div>
              <strong>${f.fee_name}</strong><br>
              <span style="color:var(--muted); font-size:13px">
                Xe: ${plate} ‚Ä¢ CƒÉn h·ªô: ${f.room_no || '-'}
              </span>
            </div>
            <div>${formatDate(f.created_at)}</div>
            <div>
              ${formatMoney(f.amount_paid || 0)} / ${formatMoney(f.amount_due || 0)}
            </div>
            <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap">
              <span class="badge ${badgeClass}">${f.status}</span>
              <button class="btn" style="padding:6px 10px; font-size:12px" onclick="viewFeePayments(${f.id})">Chi ti·∫øt</button>
              ${(f.status === 'UNPAID' || f.status === 'PARTIAL') ? `
                <button class="btn success" style="padding:6px 10px; font-size:12px" onclick="payFee(${f.id})">üí≥ Thanh to√°n</button>
              ` : ''}
            </div>
          </div>`;
      }).join('');
    }

    async function viewFeePayments(id){
      try{
        const res = await fetch(`${API_BASE}/fees/${id}/payments`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        const list = data.payments || [];
        if (!list.length){
          alert('Kho·∫£n ph√≠ n√†y ch∆∞a c√≥ thanh to√°n n√†o.');
          return;
        }
        alert(
          'C√°c l·∫ßn thanh to√°n:\n' +
          list.map(p=>`- ${formatDate(p.payment_date)}: ${formatMoney(p.amount)} (${p.method})`).join('\n')
        );
      }catch(e){
        alert('Kh√¥ng l·∫•y ƒë∆∞·ª£c l·ªãch s·ª≠ thanh to√°n.');
      }
    }

    // Thanh to√°n 1 fee c·ª• th·ªÉ
    async function payFee(feeId){
      // Hi·ªÉn th·ªã modal ƒë·ªÉ ch·ªçn ph∆∞∆°ng th·ª©c
      currentPaymentFeeId = feeId;
      selectedPaymentMethod = null;
      
      // Reset selection
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('confirmPaymentBtn').disabled = true;
      
      // Load fee info
      try{
        const res = await fetch(`${API_BASE}/fees/${feeId}`);
        const data = await res.json();
        if (!res.ok || !data.ok) throw new Error(data.message || 'Error');
        
        const fee = data.fee;
        const remaining = fee.amount_due - fee.amount_paid;
        
        document.getElementById('paymentInfo').innerHTML = 
          `<strong>${fee.fee_name}</strong><br>` +
          `Xe: ${fee.plate || '-'} ‚Ä¢ CƒÉn h·ªô: ${fee.room_no || '-'}<br>` +
          `S·ªë ti·ªÅn c·∫ßn thanh to√°n: <strong>${formatMoney(remaining)}</strong>`;
        
        // Show modal
        document.getElementById('paymentModal').classList.add('active');
      }catch(e){
        alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin kho·∫£n ph√≠.');
      }
    }

    // PAYMENT MODAL
    let currentPaymentVehicleId = null;
    let currentPaymentFeeId = null;
    let selectedPaymentMethod = null;

    function openPaymentModal(vehicleId){
      currentPaymentVehicleId = vehicleId;
      selectedPaymentMethod = null;
      
      // Reset selection
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('confirmPaymentBtn').disabled = true;
      
      // Show modal
      const modal = document.getElementById('paymentModal');
      modal.classList.add('active');
      
      // Load unpaid fees info
      loadUnpaidFeesInfo(vehicleId);
    }

    function closePaymentModal(){
      document.getElementById('paymentModal').classList.remove('active');
      currentPaymentVehicleId = null;
      currentPaymentFeeId = null;
      selectedPaymentMethod = null;
    }

    function selectPaymentMethod(method){
      selectedPaymentMethod = method;
      
      // Update UI
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.querySelector(`[data-method="${method}"]`).classList.add('selected');
      document.getElementById('confirmPaymentBtn').disabled = false;
    }

    async function loadUnpaidFeesInfo(vehicleId){
      try{
        // Load both UNPAID and PARTIAL fees
        const [unpaidRes, partialRes] = await Promise.all([
          fetch(`${API_BASE}/fees?vehicle_id=${vehicleId}&status=UNPAID&page=1&page_size=100`),
          fetch(`${API_BASE}/fees?vehicle_id=${vehicleId}&status=PARTIAL&page=1&page_size=100`)
        ]);
        
        const unpaidData = await unpaidRes.json();
        const partialData = await partialRes.json();
        
        const allFees = [
          ...(unpaidData.ok ? unpaidData.items || [] : []),
          ...(partialData.ok ? partialData.items || [] : [])
        ];
        
        const totalUnpaid = allFees.reduce((sum, f) => sum + (f.amount_due - f.amount_paid), 0);
        
        document.getElementById('paymentInfo').innerHTML = 
          `Ph∆∞∆°ng ti·ªán c√≥ <strong>${allFees.length}</strong> kho·∫£n ph√≠ ch∆∞a thanh to√°n ƒë·∫ßy ƒë·ªß.<br>` +
          `T·ªïng s·ªë ti·ªÅn c√≤n l·∫°i: <strong>${formatMoney(totalUnpaid)}</strong>`;
      }catch(e){
        console.error('Load unpaid fees error:', e);
        document.getElementById('paymentInfo').textContent = 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ph√≠ ch∆∞a thanh to√°n.';
      }
    }

    async function confirmPayment(){
      if(!selectedPaymentMethod){
        alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.');
        return;
      }

      // Tr∆∞·ªùng h·ª£p thanh to√°n 1 fee c·ª• th·ªÉ
      if(currentPaymentFeeId){
        if(!confirm(`X√°c nh·∫≠n thanh to√°n kho·∫£n ph√≠ n√†y b·∫±ng ${getPaymentMethodText(selectedPaymentMethod)}?`)){
          return;
        }

        try{
          const feeRes = await fetch(`${API_BASE}/fees/${currentPaymentFeeId}`);
          const feeData = await feeRes.json();
          if (!feeRes.ok || !feeData.ok) throw new Error(feeData.message || 'Error');
          
          const fee = feeData.fee;
          const amountToPay = fee.amount_due - fee.amount_paid;
          
          const paymentRes = await fetch(`${API_BASE}/payments`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              fee_id: currentPaymentFeeId,
              amount: amountToPay,
              method: selectedPaymentMethod,
              note: `Thanh to√°n ph√≠ g·ª≠i xe - Bi·ªÉn s·ªë ${fee.plate || ''}`
            })
          });
          
          const paymentData = await paymentRes.json();
          if(!paymentRes.ok || !paymentData.ok){
            throw new Error(paymentData.message || 'Thanh to√°n th·∫•t b·∫°i');
          }

          // C·∫≠p nh·∫≠t fee ƒë·ªÉ amount_paid = amount_due
          await fetch(`${API_BASE}/fees/${currentPaymentFeeId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              amount_paid: fee.amount_due,
              status: 'PAID'
            })
          });

          alert('‚úÖ Thanh to√°n th√†nh c√¥ng!');
          closePaymentModal();
          loadFees();
        }catch(err){
          alert('‚ùå L·ªói thanh to√°n: ' + (err.message || ''));
        }
        return;
      }

      // Tr∆∞·ªùng h·ª£p thanh to√°n t·∫•t c·∫£ fees c·ªßa vehicle
      if(!currentPaymentVehicleId){
        alert('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ph∆∞∆°ng ti·ªán ho·∫∑c kho·∫£n ph√≠.');
        return;
      }

      if(!confirm(`X√°c nh·∫≠n thanh to√°n t·∫•t c·∫£ c√°c kho·∫£n ph√≠ ch∆∞a thanh to√°n b·∫±ng ${getPaymentMethodText(selectedPaymentMethod)}?`)){
        return;
      }

      try{
        // 1. L·∫•y danh s√°ch fees ch∆∞a thanh to√°n (UNPAID + PARTIAL)
        const [unpaidRes, partialRes] = await Promise.all([
          fetch(`${API_BASE}/fees?vehicle_id=${currentPaymentVehicleId}&status=UNPAID&page=1&page_size=100`),
          fetch(`${API_BASE}/fees?vehicle_id=${currentPaymentVehicleId}&status=PARTIAL&page=1&page_size=100`)
        ]);
        
        const unpaidData = await unpaidRes.json();
        const partialData = await partialRes.json();
        
        const unpaidFees = [
          ...(unpaidData.ok ? unpaidData.items || [] : []),
          ...(partialData.ok ? partialData.items || [] : [])
        ];
        if(!unpaidFees.length){
          alert('Kh√¥ng c√≥ kho·∫£n ph√≠ n√†o c·∫ßn thanh to√°n.');
          closePaymentModal();
          return;
        }

        // 2. Thanh to√°n t·ª´ng fee
        let successCount = 0;
        for(const fee of unpaidFees){
          try{
            const amountToPay = fee.amount_due - fee.amount_paid;
            
            // T·∫°o payment
            const paymentRes = await fetch(`${API_BASE}/payments`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                fee_id: fee.id,
                amount: amountToPay,
                method: selectedPaymentMethod,
                note: `Thanh to√°n ph√≠ g·ª≠i xe - Bi·ªÉn s·ªë ${fee.plate || ''}`
              })
            });
            
            const paymentData = await paymentRes.json();
            if(paymentRes.ok && paymentData.ok){
              // C·∫≠p nh·∫≠t fee ƒë·ªÉ amount_paid = amount_due
              await fetch(`${API_BASE}/fees/${fee.id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  amount_paid: fee.amount_due,
                  status: 'PAID'
                })
              });
              successCount++;
            }
          }catch(err){
            console.error('Payment error for fee', fee.id, err);
          }
        }

        alert(`‚úÖ ƒê√£ thanh to√°n th√†nh c√¥ng ${successCount}/${unpaidFees.length} kho·∫£n ph√≠.`);
        closePaymentModal();
        
        // Reload data
        reloadVehicles();
        if(document.getElementById('tab-history').style.display !== 'none'){
          loadFees();
        }
      }catch(err){
        alert('‚ùå L·ªói thanh to√°n: ' + (err.message || ''));
      }
    }

    function getPaymentMethodText(method){
      const map = {
        'BANK_TRANSFER': 'Chuy·ªÉn kho·∫£n',
        'CARD': 'Th·∫ª t√≠n d·ª•ng',
        'CASH': 'Ti·ªÅn m·∫∑t'
      };
      return map[method] || method;
    }

    // Close modal when clicking outside
    document.getElementById('paymentModal').addEventListener('click', (e) => {
      if(e.target.id === 'paymentModal'){
        closePaymentModal();
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      reloadVehicles();
    });
  </script>

  <!-- Session & Auth Protection -->
  <script src="/common/sessionClient.js"></script>
  <script>
    // Ki·ªÉm tra authentication - redirect v·ªÅ trang login n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
    if (!session.isAuthenticated()) {
      window.location.href = '/index.html';
    }
    // Ki·ªÉm tra quy·ªÅn admin
    if (!session.isAdmin()) {
      alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
      window.location.href = '/index.html';
    }
  </script>
</body>
</html>
