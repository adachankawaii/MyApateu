<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlueMoon — Hồ sơ cá nhân</title>
  <style>
    :root{
      --bg-grad-start:#3b82f6; --bg-grad-end:#1e3a8a;
      --text:#0b1226; --muted:#56607a; --card:#ffffff; --stroke:#e6eaf5;
      --toolbar-h:64px; --radius:18px;
      --shadow:0 18px 45px rgba(13,35,69,.18);
      --shadow-2:0 10px 28px rgba(13,35,69,.16);
      --dx:24px;
    }
    [data-theme="dark"]{
      --bg-grad-start:#0f172a; --bg-grad-end:#0b1220;
      --text:#e5e7eb; --muted:#a3adc2; --card:#0b1226; --stroke:#1f2a44;
      --shadow:0 18px 45px rgba(0,0,0,.45); --shadow-2:0 10px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{
      color:var(--text);
      background: radial-gradient(1200px 800px at 70% 15%, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
      overflow-x:hidden;
    }

    .toolbar{
      position:fixed; inset:0 0 auto 0; height:var(--toolbar-h);
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
      padding:0 16px; z-index:20; color:#fff;
      background:linear-gradient(180deg,rgba(0,0,0,.18),rgba(0,0,0,.08));
      backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,.18);
    }
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:40px; height:40px; border-radius:999px; cursor:pointer;
      background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.18);
      box-shadow:0 6px 16px rgba(0,0,0,.25); transition:transform .12s ease, background .12s ease;
    }
    .icon-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.2)}
    .badge{
      display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
      background:#dbeafe; color:#1e3a8a; border:1px solid #c7d2fe;
    }
    [data-theme="dark"] .badge{ background:#1f2937; color:#e5e7eb; border-color:#374151; }

    .main{min-height:100%; padding-top:calc(var(--toolbar-h) + 28px); padding-bottom:40px;}
    .container{width:min(980px,92vw); margin:0 auto;}
    .title{margin:8px 0 18px; font-size:34px; font-weight:900; letter-spacing:.2px; color:#fff;}

    .grid{display:grid; gap:16px}
    @media (min-width:980px){ .grid{grid-template-columns: 1fr 1fr} }

    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow-2);
      padding:18px; margin-bottom:16px;
    }
    h2{margin:0 0 10px; font-size:18px}
    p{margin:8px 0; color:var(--muted)}

    .vrow{display:grid; grid-template-columns:180px 1fr; gap:12px; padding:10px 0; border-bottom:1px dashed var(--stroke);}
    .vrow:last-child{border-bottom:0}
    .vlabel{font-weight:700; color:var(--muted)}
    .vvalue{font-weight:600}

    .page.anim { animation: slideIn .28s ease both; }
    @keyframes slideIn { from{opacity:0; transform:translateX(var(--dx))} to{opacity:1; transform:none} }
    .stagger > * { opacity:0; transform: translateY(12px); }
    .stagger > *.in { animation: fadeUp .32s ease both; }
    @keyframes fadeUp{ from{opacity:0; transform:translateY(14px)} to{opacity:1; transform:none} }
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important}
      .stagger > * { opacity:1; transform:none; }
    }

    .right-actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--stroke); background:var(--card); cursor:pointer; text-decoration:none; color:inherit; box-shadow:var(--shadow-2)}
    .warn{background:#ef4444; color:#fff; border-color:#ef4444}
  </style>
</head>
<body>
  <header class="toolbar" role="banner">
    <button class="icon-btn" id="Back"></button>
    <div></div>
    <span class="badge">BlueMoon v1.0.0</span>
  </header>

  <main class="main">
    <div class="container page" id="pageRoot">
      <h1 class="title">Hồ sơ cá nhân</h1>

      <div class="grid stagger" id="stagger">
        <!-- Cột 1: Thông tin người dùng -->
        <section class="card">
          <h2>Thông tin người dùng</h2>
          <div class="vrow"><div class="vlabel">Họ và tên</div><div class="vvalue" id="v_full_name">—</div></div>
          <div class="vrow"><div class="vlabel">Tên đăng nhập</div><div class="vvalue" id="v_username">—</div></div>
           <div class="vrow"><div class="vlabel">Email</div><div class="vvalue" id="v_email">—</div></div>
          <div class="vrow"><div class="vlabel">Vai trò</div><div class="vvalue" id="v_role">—</div></div>
          <div class="vrow"><div class="vlabel">Ngày tạo</div><div class="vvalue" id="v_created_at">—</div></div>
          <div class="vrow"><div class="vlabel">Số điện thoại</div><div class="vvalue" id="v_phone">—</div></div>

          <div class="right-actions" style="margin-top:12px">
            <a class="btn warn" href="/index.html" id="btnLogout">Đăng xuất</a>
          </div>
        </section>

        <!-- Cột 2: Thông tin chung cư -->
        <section class="card">
          <h2>Thông tin chung cư</h2>
          <div class="vrow"><div class="vlabel">Tên chung cư</div><div class="vvalue" id="b_name">—</div></div>
          <div class="vrow"><div class="vlabel">Mã toà / Block</div><div class="vvalue" id="b_code">—</div></div>
          <div class="vrow"><div class="vlabel">Địa chỉ</div><div class="vvalue" id="b_address">—</div></div>
          <div class="vrow"><div class="vlabel">Ban quản lý</div><div class="vvalue" id="b_manager">—</div></div>
          <div class="vrow"><div class="vlabel">Liên hệ BQL</div><div class="vvalue" id="b_contact">—</div></div>
        </section>
      </div>

      <div class="right-actions" style="justify-content:space-between">
        <span style="color:#cfe0ff">Profile • View-only</span>
      </div>
    </div>
  </main>

  <script>
  // ===== Theme sync =====
  const themeLS = localStorage.getItem('bm_theme') || 'light';
  document.documentElement.setAttribute('data-theme', themeLS);

  // ===== Back button =====
  const backBtn = document.getElementById('Back');
  backBtn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 18l-6-6 6-6"/>
    </svg>`;
  backBtn.addEventListener('click', ()=>{ window.location.href = '/admin/dashboard.html'; });

  // ===== Anims =====
  const pageRoot = document.getElementById('pageRoot');
  const staggerWrap = document.getElementById('stagger');
  pageRoot.style.setProperty('--dx','24px');
  requestAnimationFrame(()=>{
    pageRoot.classList.add('anim');
    const kids = Array.from(staggerWrap.children);
    kids.forEach((el,i)=>{ el.style.animationDelay = `${120 + i*80}ms`; el.classList.add('in'); });
  });

  // ===== Utils =====
  const els = {
    full_name:  document.getElementById('v_full_name'),
    username:   document.getElementById('v_username'),
    email:      document.getElementById('v_email'),   // <— thêm dòng này
    role:       document.getElementById('v_role'),
    created_at: document.getElementById('v_created_at'),
    phone:      document.getElementById('v_phone'),
  };
  const b = {
    name:    document.getElementById('b_name'),
    code:    document.getElementById('b_code'),
    address: document.getElementById('b_address'),
    manager: document.getElementById('b_manager'),
    contact: document.getElementById('b_contact'),
  };

  function setText(el, val, fallback='—'){
    el.textContent = (val===null || val===undefined || val==='') ? fallback : String(val);
  }
  function fmtDate(s){
    if(!s) return '—';
    try{
      const d = new Date(String(s).replace(' ', 'T'));
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString();
    }catch{ return s; }
  }

  // ===== Loaders =====
  async function loadProfile() {
    // same-origin + include cookies (session)
    const res = await fetch('/api/me', { credentials: 'include', cache: 'no-store' });

    if (res.status === 401) {  // chưa đăng nhập
      window.location.href = '/index.html';
      return;
    }
    if (!res.ok) {
      console.error('GET /api/me failed', res.status, res.statusText);
      return;
    }

    const data = await res.json();
    setText(els.full_name,  data.full_name);
    setText(els.username,   data.username);
    setText(els.email,      data.email);
    setText(els.role,       data.role);
    setText(els.created_at, fmtDate(data.created_at));
    setText(els.phone,      data.phone);
  }

  async function loadBuilding() {
    const res = await fetch('/api/building', { credentials: 'include' });
    if (!res.ok) {
      console.warn('GET /api/building failed', res.status);
      return;
    }
    const info = await res.json();
    setText(b.name,    info.name);
    setText(b.code,    info.code);
    setText(b.address, info.address);
    setText(b.manager, info.manager);
    setText(b.contact, info.contact);
  }

  // ===== Init =====
  (async()=>{
    try{
      await Promise.all([loadProfile(), loadBuilding()]);
    }catch(e){
      console.warn(e);
    }
  })();
</script>
