<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlueMoon ‚Äî C∆∞ d√¢n & CƒÉn h·ªô</title>
  <style>
    :root{
      --bg-grad-start:#3b82f6; --bg-grad-end:#1e3a8a;
      --text:#0b1226; --muted:#56607a; --card:#ffffff; --stroke:#e6eaf5;
      --radius:16px; --shadow:0 18px 45px rgba(13,35,69,.18); --shadow-2:0 10px 28px rgba(13,35,69,.16);
    }
    [data-theme="dark"]{
      --bg-grad-start:#0f172a; --bg-grad-end:#0b1220;
      --text:#e5e7eb; --muted:#a3adc2; --card:#0b1226; --stroke:#1f2a44;
      --shadow:0 18px 45px rgba(0,0,0,.45); --shadow-2:0 10px 28px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{color:var(--text);background:radial-gradient(1200px 800px at 70% 15%, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);}

    /* Hero slideshow */
    .hero{position:relative;height:220px;overflow:hidden;border-bottom:1px solid rgba(255,255,255,.25);
      background:linear-gradient(120deg, rgba(255,255,255,.12), rgba(255,255,255,.04));backdrop-filter: blur(4px);}
    .slides{position:absolute; inset:0; display:grid}
    .slide{grid-area:1/1;background-size:cover;background-position:center;opacity:0;transform:scale(1.04);animation:fadeZoom 18s infinite;}
    .slide:nth-child(1){animation-delay:0s}.slide:nth-child(2){animation-delay:6s}.slide:nth-child(3){animation-delay:12s}
    @keyframes fadeZoom{0%{opacity:0;transform:scale(1.04)}6%{opacity:1;transform:scale(1)}28%{opacity:1}33%{opacity:0}100%{opacity:0}}
    .overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.35) 60%, transparent)}
    .toolbar{position:absolute;left:0;right:0;top:0;height:64px;z-index:3;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:0 14px;color:#fff}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);cursor:pointer}
    .hero h1{z-index:3;position:absolute;left:20px;bottom:18px;margin:0;color:#fff;font-size:24px;font-weight:900;letter-spacing:.3px;text-shadow:0 6px 22px rgba(0,0,0,.35)}

    /* Layout */
    .wrap{width:min(1180px,92vw); margin:18px auto 40px; display:grid; grid-template-columns: 360px 1fr; gap:18px}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }
    .panel{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow-2); overflow:hidden}
    .left .head{display:flex; gap:10px; padding:12px; border-bottom:1px solid var(--stroke); background:linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,.35))}
    [data-theme="dark"] .left .head{background:linear-gradient(180deg, rgba(17,24,39,.65), rgba(17,24,39,.35))}
    .search{flex:1; display:flex; align-items:center; gap:8px; height:38px; padding:0 10px; border-radius:999px; background:#ffffff; border:1px solid var(--stroke)}
    [data-theme="dark"] .search{background:#0b1226}
    .search input{flex:1;border:0;outline:0;background:transparent;color:var(--text)}
    .flt{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
    .flt select{height:38px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--text);padding:0 10px}

    .list{max-height:calc(100dvh - 360px); overflow:auto; padding:8px}
    .room{border:1px solid var(--stroke); border-radius:14px; padding:10px; margin:8px 4px; display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center; cursor:pointer; background:color-mix(in oklab, var(--card) 96%, transparent)}
    .room:hover{box-shadow:var(--shadow-2)}
    .room .badge{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--stroke); color:var(--muted)}
    .room .name{font-weight:900; letter-spacing:.2px}
    .room .sub{font-size:12px; color:var(--muted)}
    .active{outline:2px solid #2563eb}

    .right .body{padding:14px}
    .kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 720px){ .kv{grid-template-columns:1fr} }
    .card{border:1px solid var(--stroke); border-radius:14px; padding:12px; background:var(--card)}
    .card h4{margin:0 0 8px; font-size:14px}
    table{width:100%; border-collapse:collapse}
    th, td{border-bottom:1px solid var(--stroke); text-align:left; padding:8px}
    th{font-size:12px; color:var(--muted); letter-spacing:.2px}
    .empty{padding:28px; text-align:center; color:var(--muted)}

    /* Buttons (for forms) */
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);cursor:pointer}

 /* ==== Modal sizing & scroll ==== */
#modalCard{
  /* r·ªông h∆°n ch√∫t ƒë·ªÉ 3 c·ªôt tho√°ng, v·∫´n fit viewport */
  width: min(1000px, 96vw) !important;
  max-height: 92vh;                /* kh√¥ng v∆∞·ª£t chi·ªÅu cao m√†n */
  display: flex;
  flex-direction: column;
}

/* ph·∫ßn form l√† v√πng cu·ªôn; ti√™u ƒë·ªÅ & actions kh√¥ng cu·ªôn */
#modalForm{
  padding: 12px !important;
  overflow: auto;
  /* ch·ª´a ch·ªó cho header + sticky actions ~ 120px */
  max-height: calc(92vh - 120px);
}

/* ==== 3 c·ªôt card hi·ªán ƒë·∫°i, g·ªçn d·ªçc h∆°n ==== */
.modal-grid{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 12px;
}
@media (max-width: 1100px){ .modal-grid{ grid-template-columns: 1fr 1fr; } }
@media (max-width: 680px){ .modal-grid{ grid-template-columns: 1fr; } }

.cardx{
  border:1px solid var(--stroke);
  border-radius: var(--radius);
  background: var(--card);
  box-shadow: var(--shadow-2);
  overflow:hidden;
}
.cardx .cardx-head{
  padding:8px 12px;                /* header card th·∫•p h∆°n */
  border-bottom:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.55),rgba(255,255,255,.25));
  font-weight:900; font-size:14px;
}
[data-theme="dark"] .cardx .cardx-head{
  background:linear-gradient(180deg, rgba(17,24,39,.55), rgba(17,24,39,.25));
}
.cardx .cardx-body{
  padding:10px 12px;               /* body card g·ªçn l·∫°i */
  display:grid; gap:8px;
}

/* ==== Field compact ==== */
.field label{font-size:12px; color:var(--muted); display:block; margin-bottom:4px}
.field input,.field select{
  width:100%;
  height: 34px;                    /* th·∫•p h∆°n 38px */
  padding:0 10px;
  border:1px solid var(--stroke);
  border-radius:8px;               /* bo g√≥c g·ªçn l·∫°i */
  background:var(--card); color:var(--text); outline:none;
}

/* ==== Sticky actions (n√∫t lu√¥n th·∫•y) ==== */
.actions-row{
  position: sticky;
  bottom: 0;
  padding-top: 10px;
  display:flex; gap:8px; justify-content:flex-end;
  background: linear-gradient(180deg, transparent, color-mix(in oklab, var(--card) 92%, transparent));
  border-top: 1px solid var(--stroke);
}

/* N√∫t trong modal nh√¨n ‚Äúƒë·∫ßm‚Äù h∆°n m·ªôt ch√∫t */
.actions-row .btn{
  height: 36px;
  padding: 0 12px;
  border-radius: 10px;
}

  </style>
</head>

<body>
  <!-- ==== Modal overlay (forms) ==== -->
  <div id="modalOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50">
    <div id="modalCard" style="width:min(560px,94vw);background:var(--card);color:var(--text);border:1px solid var(--stroke);border-radius:14px;box-shadow:var(--shadow);overflow:hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--stroke)">
        <h3 id="modalTitle" style="margin:0;font-size:16px;font-weight:900">Form</h3>
        <button id="modalClose" class="btn">‚úï</button>
      </div>
      <form id="modalForm" style="padding:14px;display:grid;gap:10px"><!-- fields inject here --></form>
    </div>
  </div>

  <section class="hero">
    <div class="slides">
      <div class="slide" style="background-image:radial-gradient(1200px 700px at 70% 20%, rgba(37,99,235,.35), transparent), url('https://images.unsplash.com/photo-1501183638710-841dd1904471?q=80&w=1500&auto=format&fit=crop');"></div>
      <div class="slide" style="background-image:radial-gradient(1200px 700px at 70% 20%, rgba(37,99,235,.35), transparent), url('https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?q=80&w=1500&auto=format&fit=crop');"></div>
      <div class="slide" style="background-image:radial-gradient(1200px 700px at 70% 20%, rgba(37,99,235,.35), transparent), url('https://images.unsplash.com/photo-1449844908441-8829872d2607?q=80&w=1500&auto=format&fit=crop');"></div>
    </div>
    <div class="overlay"></div>
    <div class="toolbar">
      <button class="icon-btn" id="Back" title="Quay l·∫°i">‚üµ</button>
      <span></span>
      <button class="icon-btn" id="Theme" title="ƒê·ªïi giao di·ªán">‚òº</button>
    </div>
    <h1>C∆∞ d√¢n & CƒÉn h·ªô</h1>
  </section>

  <main class="wrap">
    <section class="panel left" aria-label="Danh s√°ch ph√≤ng">
      <div class="head">
        <label class="search" style="flex:1">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#64748b" stroke-width="1.6"/><path d="M20 20l-3.2-3.2" stroke="#64748b" stroke-width="1.6" stroke-linecap="round"/></svg>
          <input id="q" placeholder="T√¨m s·ªë ph√≤ng ho·∫∑c ch·ªß h·ªô..." />
        </label>
        <div class="flt">
          
          <select id="fltStatus">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="rental">ƒêang thu√™</option>
            <option value="sold">ƒê√£ b√°n</option>
          </select>
          <select id="fltType">
            <option value="">T·∫•t c·∫£ lo·∫°i ph√≤ng</option>
            <option value="studio">Studio</option>
            <option value="1_ng·ªß">1 ng·ªß</option>
            <option value="2_ng·ªß">2 ng·ªß</option>
            <option value="kh√°c">Kh√°c</option>
          </select>
        </div>
      </div>
      <div class="list" id="roomList" role="list"></div>
    </section>

    <section class="panel right" aria-label="Chi ti·∫øt ph√≤ng">
      <div class="body" id="detail">
        <div class="empty">Ch·ªçn m·ªôt ph√≤ng ƒë·ªÉ xem chi ti·∫øt.</div>
      </div>
    </section>
  </main>

  <script>
    // Theme + back
    const theme = localStorage.getItem('bm_theme') || 'light';
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('Theme').onclick = ()=>{
      const cur = document.documentElement.getAttribute('data-theme');
      const next = cur==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('bm_theme', next);
    };
    document.getElementById('Back').onclick = ()=> window.location.href='home_admin.html';

    // State
    const state = { rooms:[], currentRoomId:null, cacheResidents:new Map(), selectedResidents: new Set() };

    // Fetch helpers
    async function getJSON(url){
      const r = await fetch(url, { credentials:'include' });
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }
    async function postJSON(url, payload){
      const r = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        credentials:'include', body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=>({}));
      if(!r.ok) throw new Error(data.message || ('HTTP '+r.status));
      return data;
    }
    async function putJSON(url, payload){
      const r = await fetch(url, {
        method:'PUT', headers:{'Content-Type':'application/json'},
        credentials:'include', body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=>({}));
      if(!r.ok) throw new Error(data.message || ('HTTP '+r.status));
      return data;
    }

    async function loadRooms(params={}){
      const qs = new URLSearchParams(params).toString();
      return getJSON('/api/rooms' + (qs?('?'+qs):''));
    }
    async function loadResidents(roomId){
      if (state.cacheResidents.has(roomId)) return state.cacheResidents.get(roomId);
      const data = await getJSON(`/api/rooms/${roomId}/persons`); // <-- s·ª≠a ƒë√∫ng endpoint
      state.cacheResidents.set(roomId, data);
      return data;
    }

    // Render list
    function renderRooms(){
      const box = document.getElementById('roomList');
      box.innerHTML = '';
      if(!state.rooms.length){ box.innerHTML='<div class="empty">Kh√¥ng c√≥ ph√≤ng.</div>'; return; }
      state.rooms.forEach(r=>{
        const el = document.createElement('div');
        el.className = 'room' + (state.currentRoomId===r.id?' active':'');
        el.innerHTML = `
          <div class="badge">${r.status || 'N/A'}</div>
          <div>
            <div class="name">Ph√≤ng ${r.room_no} ‚Ä¢ ${r.room_type||'--'}</div>
            <div class="sub">Ch·ªß h·ªô: ${r.head_name||'-'}${r.head_phone?` ‚Ä¢ ${r.head_phone}`:''}</div>
          </div>
          <div class="sub">${(r.occupants_count_calc ?? r.occupants_count) || 0} ng∆∞·ªùi</div>
        `;
        el.onclick = ()=> selectRoom(r.id);
        box.appendChild(el);
      });
    }

    // Render detail
    // Render detail
async function renderDetail(){
  const d = document.getElementById('detail');
  const room = state.rooms.find(x=>x.id===state.currentRoomId);
  if(!room){ d.innerHTML='<div class="empty">Ch·ªçn m·ªôt ph√≤ng ƒë·ªÉ xem chi ti·∫øt.</div>'; return; }

  const people = await loadResidents(room.id);

  // toolbar xo√° nhi·ªÅu
  const selectedCount = state.selectedResidents.size;
  const toolbarHTML = people.length ? `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <button id="btnBulkDelete" class="btn" style="background:#ef4444;color:#fff;border-color:#ef4444"
              ${selectedCount ? '' : 'disabled'}>üóë Xo√° ƒë√£ ch·ªçn (${selectedCount})</button>
      <span class="sub"></span>
    </div>
  ` : '';

  d.innerHTML = `
    <div class="kv">
      <div class="card">
        <h4>Th√¥ng tin ph√≤ng</h4>
        <table>
          <tr><th>S·ªë ph√≤ng</th><td>${room.room_no}</td></tr>
          <tr><th>Lo·∫°i ph√≤ng</th><td>${room.room_type||'-'}</td></tr>
          <tr><th>Tr·∫°ng th√°i</th><td>${room.status||'-'}</td></tr>
          <tr><th>Ng√†y b·∫Øt ƒë·∫ßu Hƒê</th><td>${room.contract_start||'-'}</td></tr>
          <tr><th>Ng√†y k·∫øt th√∫c Hƒê</th><td>${room.contract_end||'-'}</td></tr>
          <tr><th>Ch·ªß h·ªô</th><td>${room.head_name||'-'}</td></tr>
          <tr><th>SƒêT ch·ªß h·ªô</th><td>${room.head_phone||'-'}</td></tr>
          <tr><th>S·ªë ng∆∞·ªùi (t√≠nh)</th><td>${room.occupants_count_calc ?? '-'}</td></tr>
        </table>
      </div>
      <div class="card">
        <h4>Thao t√°c</h4>
        <button class="btn" id="btnAddRoom" style="margin-left:8px">+ Th√™m ph√≤ng</button>
        <button class="btn" id="btnAddpersons" style="margin-left:8px">Th√™m c∆∞ d√¢n</button>
        <button class="btn" id="btnDeleteRoom" style="margin-left:8px;background:#ef4444;color:#fff;border-color:#ef4444">X√≥a ph√≤ng</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Danh s√°ch c∆∞ d√¢n</h4>
      ${people.length ? `
        ${toolbarHTML}
        <table>
          <thead><tr>
            <th style="width:38px"></th>
            <th>H·ªç t√™n</th><th>CCCD</th><th>Quan h·ªá</th><th>Ngh·ªÅ nghi·ªáp</th>
            <th>Ng√†y sinh</th><th>Qu√™ qu√°n</th><th>ƒêi·ªán tho·∫°i</th>
          </tr></thead>
          <tbody>
            ${people.map(p=>{
              const isHead = (p.relation_to_head === 'Ch·ªß h·ªô');
              const checked = state.selectedResidents.has(p.id) ? 'checked' : '';
              const cb = isHead ? '' :
                `<input type="checkbox" data-rid="${p.id}" ${checked} aria-label="Ch·ªçn c∆∞ d√¢n ${p.full_name}">`;
              return `
                <tr>
                  <td>${cb}</td>
                  <td>${p.full_name||''}</td>
                  <td>${p.cccd||''}</td>
                  <td>${p.relation_to_head||''}</td>
                  <td>${p.occupation||''}</td>
                  <td>${p.dob||''}</td>
                  <td>${p.hometown||''}</td>
                  <td>${p.phone||''}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      ` : '<div class="empty">Ch∆∞a c√≥ c∆∞ d√¢n trong ph√≤ng n√†y.</div>'}
    </div>
  `;

  // attach actions c≈©
  document.getElementById('btnAddpersons').addEventListener('click', () => openResidentForm(room));
  document.getElementById('btnAddRoom').addEventListener('click', openCreateRoomBundleForm);
  // Xo√° ph√≤ng (xo√° c·∫£ c∆∞ d√¢n + t√†i kho·∫£n ch·ªß h·ªô)
  document.getElementById('btnDeleteRoom').addEventListener('click', async ()=>{
    // l·∫•y danh s√°ch c∆∞ d√¢n ƒë√£ load ·ªü tr√™n
    const people = await loadResidents(room.id).catch(()=>[]);
    const head = people.find(p => p.relation_to_head === 'Ch·ªß h·ªô');
    const msg = [
      `B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° PH√íNG ${room.room_no}?`,
      `‚Ä¢ S·∫Ω xo√° to√†n b·ªô c∆∞ d√¢n trong ph√≤ng (k·ªÉ c·∫£ Ch·ªß h·ªô).`,
      `‚Ä¢ S·∫Ω xo√° t√†i kho·∫£n c·ªßa Ch·ªß h·ªô${head ? ` (${head.full_name})` : ''}.`,
      `‚Ä¢ Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
    ].join('\n');

    if (!confirm(msg)) return;

    try{
      const r = await fetch(`/api/rooms/${room.id}`, { method:'DELETE', credentials:'include' });
      const data = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(data.message || `HTTP ${r.status}`);

      // l√†m t∆∞∆°i danh s√°ch ph√≤ng
      state.cacheResidents.delete(room.id);
      state.selectedResidents.clear();
      state.rooms = await loadRooms({
        q: document.getElementById('q').value.trim(),
        status: document.getElementById('fltStatus').value,
        room_type: document.getElementById('fltType').value
      }).catch(()=>state.rooms);

      renderRooms();
      // ch·ªçn ph√≤ng ƒë·∫ßu ti√™n c√≤n l·∫°i n·∫øu c√≥, n·∫øu kh√¥ng hi·ªÉn th·ªã r·ªóng
      if (state.rooms[0]) {
        await selectRoom(state.rooms[0].id);
      } else {
        const d = document.getElementById('detail');
        d.innerHTML = '<div class="empty">Ch∆∞a c√≥ ph√≤ng n√†o.</div>';
      }
      alert('ƒê√£ xo√° ph√≤ng v√† d·ªØ li·ªáu li√™n quan.');
    }catch(err){
      alert(err.message || 'Kh√¥ng xo√° ƒë∆∞·ª£c ph√≤ng');
    }
  });

  // ====== NEW: checkbox ch·ªçn c∆∞ d√¢n (kh√¥ng cho Ch·ªß h·ªô) ======
  d.querySelectorAll('input[type="checkbox"][data-rid]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const id = Number(cb.getAttribute('data-rid'));
      if (cb.checked) state.selectedResidents.add(id);
      else state.selectedResidents.delete(id);
      const btn = d.querySelector('#btnBulkDelete');
      if (btn){
        const c = state.selectedResidents.size;
        btn.disabled = c === 0;
        btn.textContent = `üóë Xo√° ƒë√£ ch·ªçn (${c})`;
      }
    });
  });

  // ====== NEW: n√∫t xo√° ƒë√£ ch·ªçn ======
  const btnDel = d.querySelector('#btnBulkDelete');
  if (btnDel){
    btnDel.addEventListener('click', async ()=>{
      const ids = Array.from(state.selectedResidents);
      if (!ids.length) return;
      if (!confirm(`Xo√° ${ids.length} c∆∞ d√¢n ƒë√£ ch·ªçn?`)) return;

      try{
        // Y√äU C·∫¶U backend c√≥ /api/persons/bulk_delete (ƒë√£ g·ª£i √Ω ·ªü b∆∞·ªõc tr∆∞·ªõc)
        await postJSON('/api/persons/bulk_delete', { ids });

        // refresh b·∫£ng + ƒë·∫øm
        state.selectedResidents.clear();
        state.cacheResidents.delete(room.id);
        await renderDetail();

        state.rooms = await loadRooms({
          q: document.getElementById('q').value.trim(),
          status: document.getElementById('fltStatus').value,
          room_type: document.getElementById('fltType').value
        }).catch(()=>state.rooms);
        renderRooms();
      }catch(err){
        alert(err.message || 'Kh√¥ng xo√° ƒë∆∞·ª£c c∆∞ d√¢n');
      }
    });
  }
}


    async function selectRoom(id){
      state.currentRoomId = id;
      state.selectedResidents.clear();   // reset c√°c checkbox khi ƒë·ªïi ph√≤ng
      renderRooms();
      await renderDetail();
    }


    // Filters & search
    async function applyFilter(){
      const q = document.getElementById('q').value.trim();
      const status = document.getElementById('fltStatus').value;
      const room_type = document.getElementById('fltType').value;
      state.rooms = await loadRooms({ q, status, room_type }).catch(()=>[]);
      renderRooms();
      if (state.rooms.length && !state.rooms.find(r=>r.id===state.currentRoomId)){
        await selectRoom(state.rooms[0].id);
      }
    }

    document.getElementById('q').addEventListener('input', ()=>{
      clearTimeout(window.__qTimer);
      window.__qTimer = setTimeout(applyFilter, 250);
    });
    document.getElementById('fltStatus').addEventListener('change', applyFilter);
    document.getElementById('fltType').addEventListener('change', applyFilter);

    // ===== Modal helpers =====
    const $overlay = document.getElementById('modalOverlay');
    const $title   = document.getElementById('modalTitle');
    const $form    = document.getElementById('modalForm');
    document.getElementById('modalClose').onclick = closeModal;
    $overlay.addEventListener('click', (e)=>{ if(e.target === $overlay) closeModal(); });

    function openModal(title, innerHTML, onSubmit){
      $title.textContent = title;
      $form.innerHTML = innerHTML;
      $form.onsubmit = async (e)=>{
        e.preventDefault();
        const fd = new FormData($form);
        const data = Object.fromEntries(fd.entries());
        try{
          await onSubmit(data);
          closeModal();
        }catch(err){
          alert(err.message || 'C√≥ l·ªói x·∫£y ra');
        }
      };
      $overlay.style.display = 'flex';
    }
    function closeModal(){
      $overlay.style.display = 'none';
      $form.innerHTML = '';
      $form.onsubmit = null;
    }

    // ===== Forms =====
    // ==== helper chu·∫©n, c√≥ credentials ƒë·ªÉ g·ª≠i cookie phi√™n ====
    async function postJSON(url, payload){
      const r = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        credentials: 'include',        // g·ª≠i cookie session
        body: JSON.stringify(payload),
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok){
        const msg = data?.message || `HTTP ${r.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // ===== Create bundle: Room + User (+ Person if role=user) =====
    function openCreateRoomBundleForm(){
      const html = `
        <div class="modal-grid">

          <!-- Card 1: Ph√≤ng -->
          <div class="cardx" id="roomCard">
            <div class="cardx-head">Ph√≤ng</div>
            <div class="cardx-body">
              <div class="field">
                <label>S·ªë ph√≤ng*</label>
                <input name="room_no" required>
              </div>

              <div class="field">
                <label>Lo·∫°i ph√≤ng</label>
                <select name="room_type">
                  <option value=""></option>
                  <option value="studio">studio</option>
                  <option value="1_ng·ªß">1 ng·ªß</option>
                  <option value="2_ng·ªß">2 ng·ªß</option>
                  <option value="kh√°c">kh√°c</option>
                </select>
              </div>

              <div class="field">
                <label>Tr·∫°ng th√°i</label>
                <select name="status">
                  <option value=""></option>
                  <option value="rental">Cho thu√™</option>
                  <option value="sold">ƒê√£ b√°n</option>
                </select>
              </div>

              <div class="field">
                <label>Hƒê b·∫Øt ƒë·∫ßu (YYYY-MM-DD)</label>
                <input name="contract_start" placeholder="2025-10-10">
              </div>

              <div class="field">
                <label>Hƒê k·∫øt th√∫c (YYYY-MM-DD)</label>
                <input name="contract_end" placeholder="2030-10-10">
              </div>

              <div class="field">
                <label>S·ªë ng∆∞·ªùi (tu·ª≥ ch·ªçn)</label>
                <input name="occupants_count">
              </div>
            </div>
          </div>

          <!-- Card 2: T√†i kho·∫£n -->
          <div class="cardx" id="accountCard">
            <div class="cardx-head">T√†i kho·∫£n</div>
            <div class="cardx-body">
              <div class="field">
                <label>T√™n ƒëƒÉng nh·∫≠p*</label>
                <input name="username" required>
              </div>

              <div class="field">
                <label>M·∫≠t kh·∫©u*</label>
                <input name="password" type="password" required>
              </div>

              <div class="field">
                <label>S·ªë ƒëi·ªán tho·∫°i</label>
                <input name="phone">
              </div>
              <div class="field">
                <label>Email</label>
                <input name="email" type="email" placeholder="name@example.com">
              </div>

              <div class="field">
                <label>H·ªç t√™n hi·ªÉn th·ªã*</label>
                <input name="full_name" required>
              </div>

              <div class="field">
                <label>Vai tr√≤*</label>
                <select name="role" required>
                  <option value="user" selected>user</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Card 3: Ch·ªß h·ªô (·∫©n khi role=admin) -->
          <div class="cardx" id="personCard">
            <div class="cardx-head">Ch·ªß h·ªô (ghi v√†o b·∫£ng persons khi role = user)</div>
            <div class="cardx-body">
              <div class="field">
                <label>H·ªç t√™n ch·ªß h·ªô*</label>
                <input name="p_full_name" required>
              </div>

              <div class="field">
                <label>CCCD</label>
                <input name="p_cccd">
              </div>

              <div class="field">
                <label>D√¢n t·ªôc</label>
                <input name="p_ethnicity">
              </div>

              <div class="field">
                <label>Ngh·ªÅ nghi·ªáp</label>
                <input name="p_occupation">
              </div>

              <div class="field">
                <label>Ng√†y sinh (YYYY-MM-DD)</label>
                <input name="p_dob" placeholder="1980-10-20">
              </div>

              <div class="field">
                <label>Qu√™ qu√°n</label>
                <input name="p_hometown">
              </div>

              <div class="field">
                <label>Quan h·ªá v·ªõi ch·ªß h·ªô</label>
                <select name="p_relation_to_head">
                  <option value="Ch·ªß h·ªô" selected>Ch·ªß h·ªô</option>
                </select>
              </div>

              <div class="field">
                <label>ƒêi·ªán tho·∫°i</label>
                <input name="p_phone">
              </div>
            </div>
          </div>

        </div>

        <div class="actions-row">
          <button type="button" class="btn" onclick="closeModal()">H·ªßy</button>
          <button type="submit" class="btn" style="background:#2563eb;color:#fff;border-color:#2563eb">T·∫°o</button>
        </div>

      `;

      openModal('Th√™m ph√≤ng m·ªõi + t√†i kho·∫£n', html, async (data)=>{
        try{
        // 1) Chu·∫©n ho√°: field r·ªóng -> b·ªè, s·ªë -> √©p ki·ªÉu
        const clean = (obj)=>{ Object.keys(obj).forEach(k=> (obj[k]==='' ? delete obj[k] : 0)); return obj; };
        clean(data);
        if (data.occupants_count) data.occupants_count = Number(data.occupants_count);
        
        // 2) Chu·∫©n b·ªã payload cho API bundle /api/rooms (POST)
        const payload = {
          room_no: data.room_no,
          room_type: data.room_type || null,
          status: data.status || null,
          contract_start: data.contract_start || null,
          contract_end: data.contract_end || null,
          occupants_count: data.occupants_count ?? null,

          username: data.username,
          password: data.password,
          phone: data.phone || null,
          email: data.email || null,  
          full_name: data.full_name,
          role: data.role,

          // ch·ªâ g·ª≠i person_data khi role = 'user'
          person_data: (data.role === 'user') ? {
            full_name: data.p_full_name,
            cccd: data.p_cccd || null,
            ethnicity: data.p_ethnicity || null,
            occupation: data.p_occupation || null,
            dob: data.p_dob || null,
            hometown: data.p_hometown || null,
            relation_to_head: data.p_relation_to_head || 'Ch·ªß h·ªô',
            phone: data.p_phone || null
          } : undefined
        };

        const res = await postJSON('/api/rooms', payload); // backend s·∫Ω: t·∫°o user -> t·∫°o room(user_id) -> n·∫øu user => t·∫°o person & link
        // L√†m t∆∞∆°i danh s√°ch + ch·ªçn ph√≤ng m·ªõi t·∫°o
        state.rooms = await loadRooms().catch(()=>state.rooms);
        renderRooms();
        const newId = res?.room?.id || (state.rooms[state.rooms.length-1]?.id); // fallback
        if (newId) await selectRoom(newId);
        alert('T·∫°o ph√≤ng + t√†i kho·∫£n th√†nh c√¥ng!');
        }catch(err){
          // l·ªói hay g·∫∑p: 409 tr√πng username/room_no; 400 thi·∫øu field
          alert(err.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o ph√≤ng');
          throw err;  // ƒë·ªÉ openModal b·∫Øt & kh√¥ng t·ª± ƒë√≥ng n·∫øu b·∫°n mu·ªën
        }
      });

      // Toggle kh·ªëi ch·ªß h·ªô theo role
      const $role = $form.querySelector('select[name="role"]');
      const $personBlock = $form.querySelector('#personCard');
      const syncPersonBlock = ()=>{
        $personBlock.style.display = ($role.value==='user') ? '' : 'none';
        $form.querySelector('[name="p_full_name"]').required = ($role.value==='user');
      };
      $role.addEventListener('change', syncPersonBlock);
      syncPersonBlock();

    }

    function openResidentForm(room){
      const html = `
        <input type="hidden" name="room_id" value="${room.id}">
        <label>H·ªç t√™n*<br><input name="full_name" required style="width:100%"></label>
        <label>CCCD<br><input name="cccd" style="width:100%"></label>
        <label>D√¢n t·ªôc<br><input name="ethnicity" style="width:100%"></label>
        <label>Ngh·ªÅ nghi·ªáp<br><input name="occupation" style="width:100%"></label>
        <label>Ng√†y sinh (YYYY-MM-DD)<br><input name="dob" placeholder="1980-10-20" style="width:100%"></label>
        <label>Qu√™ qu√°n<br><input name="hometown" style="width:100%"></label>
        <label>Quan h·ªá v·ªõi ch·ªß h·ªô<br>
          <select name="relation_to_head" style="width:100%">
            <option value="C∆∞ d√¢n">C∆∞ d√¢n</option>
          </select>
        </label>
        <label>ƒêi·ªán tho·∫°i<br><input name="phone" style="width:100%"></label>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button type="button" class="btn" onclick="closeModal()">H·ªßy</button>
          <button type="submit" class="btn" style="background:#2563eb;color:#fff;border-color:#2563eb">L∆∞u</button>
        </div>
      `;
      openModal(`Th√™m c∆∞ d√¢n ‚Ä¢ Ph√≤ng ${room.room_no}`, html, async (data)=>{
        await postJSON('/api/persons', data);
        // Refresh
        state.cacheResidents.delete(room.id);
        await renderDetail();
        state.rooms = await loadRooms({
          q: document.getElementById('q').value.trim(),
          status: document.getElementById('fltStatus').value,
          room_type: document.getElementById('fltType').value
        }).catch(()=>state.rooms);
        renderRooms();
      });
    }
    
    // Boot
    (async function init(){
      try{
        state.rooms = await loadRooms();
        renderRooms();
        if (state.rooms[0]) await selectRoom(state.rooms[0].id);
      }catch(e){
        console.error(e);
        document.getElementById('roomList').innerHTML = '<div class="empty">L·ªói t·∫£i d·ªØ li·ªáu.</div>';
      }
    })();
  </script>
</body>
</html>
